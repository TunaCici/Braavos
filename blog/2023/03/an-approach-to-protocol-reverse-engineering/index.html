<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> An approach to protocol reverse-engineering | joonas.fi</title>
  <meta name="description" content="Letâ€™s get to work á••( á› )á•—">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="An approach to protocol reverse-engineering" />
<meta property="og:description" content="This basic principle has worked for me many times, so I figured it might be worth to share the process.
In this instance I wanted to write a label printer driver in Go. A barebones implementation exists in Python that works to print a test image.
The idea If I can reach parity with the Python-based implementation (from now on referred to as the reference implementation), I can build on top of a working baseline." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://joonas.fi/2023/03/an-approach-to-protocol-reverse-engineering/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-12T07:57:12+00:00" />
<meta property="article:modified_time" content="2023-03-12T07:57:12+00:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="An approach to protocol reverse-engineering"/>
<meta name="twitter:description" content="This basic principle has worked for me many times, so I figured it might be worth to share the process.
In this instance I wanted to write a label printer driver in Go. A barebones implementation exists in Python that works to print a test image.
The idea If I can reach parity with the Python-based implementation (from now on referred to as the reference implementation), I can build on top of a working baseline."/>

  
  
  
  <link rel="stylesheet" href="/css/style-white.css">
  
   <link rel="stylesheet" href="/css/custom.css"> 
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  <link rel="icon" type="image/png" href="/favicon.ico" />
  
  
  
  
  
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-24122659-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/today-i-learned/">Today I Learned</a></li>
         
        <li><a href="/about/">About</a></li>
         
        <li><a href="/contact/">Contact</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://joonas.fi/today-i-learned/2022/qmk-numpad-hack-for-tkl-keyboards/">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f&text=An%20approach%20to%20protocol%20reverse-engineering">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f&title=An%20approach%20to%20protocol%20reverse-engineering">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f&is_video=false&description=An%20approach%20to%20protocol%20reverse-engineering">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=An%20approach%20to%20protocol%20reverse-engineering&body=Check out this article: https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f&title=An%20approach%20to%20protocol%20reverse-engineering">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f&title=An%20approach%20to%20protocol%20reverse-engineering">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f&title=An%20approach%20to%20protocol%20reverse-engineering">
      <i class="fab fa-stumbleupon " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f&title=An%20approach%20to%20protocol%20reverse-engineering">
      <i class="fab fa-digg " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f&name=An%20approach%20to%20protocol%20reverse-engineering&description=This%20basic%20principle%20has%20worked%20for%20me%20many%20times%2c%20so%20I%20figured%20it%20might%20be%20worth%20to%20share%20the%20process.%0aIn%20this%20instance%20I%20wanted%20to%20write%20a%20label%20printer%20driver%20in%20Go.%20A%20barebones%20implementation%20exists%20in%20Python%20that%20works%20to%20print%20a%20test%20image.%0aThe%20idea%20If%20I%20can%20reach%20parity%20with%20the%20Python-based%20implementation%20%28from%20now%20on%20referred%20to%20as%20the%20reference%20implementation%29%2c%20I%20can%20build%20on%20top%20of%20a%20working%20baseline.">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f&t=An%20approach%20to%20protocol%20reverse-engineering">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#the-idea">The idea</a></li>
    <li><a href="#capturing-sent-data-from-the-reference-implementation">Capturing sent data from the reference implementation</a></li>
    <li><a href="#making-a-test-suite-at-go-side">Making a test suite at Go side</a></li>
    <li><a href="#making-the-first-tests-pass">Making the first tests pass</a></li>
    <li><a href="#fixing-the-rest-of-the-tests">Fixing the rest of the tests</a></li>
    <li><a href="#result-working-prints">Result: working prints</a></li>
    <li><a href="#summary">Summary</a></li>
    <li><a href="#sidetalk-why-not-extend-the-original-implementation">Sidetalk: why not extend the original implementation?</a></li>
  </ul>
</nav>
    </div>
  </span>
</div>

<div class="alert-warning">
	ðŸš¨
	<a href="https://www.reuters.com/world/europe/icc-says-may-investigate-possible-war-crimes-after-russian-invasion-ukraine-2022-02-25/">Putin is a war criminal</a>.
	<a href="https://arstechnica.com/science/2022/03/russia-attacked-ukrainian-hospitals-violating-humanitarian-law-who-says/">Russians are bombing hospitals</a>.
	ðŸ’”ðŸ‡ºðŸ‡¦
</div>



  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
    
      <img src="header.jpg" class="hero" alt="Raccoon reaching around in a toolbox, digital art" />
    

      <h1 class="posttitle" itemprop="name headline">
        An approach to protocol reverse-engineering
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2023-03-12 07:57:12 &#43;0000 UTC" itemprop="datePublished">2023-03-12</time>
          
        </div>
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/tags/programming/" rel="tag">programming</a>
            
             ,  
            <a class="tag-link" href="/tags/technology/" rel="tag">technology</a>
            
        </div>
        
      </div>
    </header>

  
    <div class="content" itemprop="articleBody">
      <p>This basic principle has worked for me many times, so I figured it might be worth to share the process.</p>
<p>In this instance I wanted to write a label printer driver in Go.
A barebones implementation exists in Python that works to print a test image.</p>
<h2 id="the-idea">The idea</h2>
<p>If I can reach parity with the Python-based implementation (from now on referred to as the reference implementation),
I can build on top of a working baseline.</p>
<p>But how to reach parity? By writing tests that assert that we are sending the <em>exact same bits</em> as the reference implementation.</p>
<p><img src="high-level-drawing.png" alt=""></p>
<h2 id="capturing-sent-data-from-the-reference-implementation">Capturing sent data from the reference implementation</h2>
<p>At high level this specific printer uses a serial port over Bluetooth.</p>
<p>We can observe that
<a href="https://github.com/robby-cornelissen/pt-p710bt-label-maker/tree/99e76c71f4fd6c56e7ff411494034751213a1777">the reference implementation</a>
sends each datagram with the socket&rsquo;s <code>send()</code> method:</p>
<p><img src="datagram-send-points.png" alt=""></p>
<p>If we capture all data sent to the <code>send()</code> method, then we can in our implementation have a test
suite that asserts that we will send the same data.</p>
<p>To record the data, I changed all call sites to use a wrapper that stores those invividual datagrams:</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span> def send_initialize(socket):
</span></span><span style="display:flex;"><span>     # send [1B 40]
</span></span><span style="display:flex;"><span><span style="background-color:#fcc">-    socket.send(b&#34;\x1B\x40&#34;)
</span></span></span><span style="display:flex;"><span><span style="background-color:#fcc"></span><span style="background-color:#cfc">+    socket_send(socket, b&#34;\x1B\x40&#34;)
</span></span></span></code></pre></div><p>The implementation of the new <code>socket_send()</code> just wraps the send and also stores the sent datagram in a list:</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sent_datagrams <span style="color:#2c5dcd">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">def</span> <span style="color:#ff8000;font-weight:bold">socket_send</span>(socket, data):
</span></span><span style="display:flex;"><span>    <span style="color:#0080ff;font-style:italic"># base64 because: https://stackoverflow.com/questions/44682018/typeerror-object-of-type-bytes-is-not-json-serializable</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0080ff;font-style:italic"># I have to... decode it to ascii...???! ðŸ¤¦</span>
</span></span><span style="display:flex;"><span>    sent_datagrams<span style="color:#2c5dcd">.</span>append(base64<span style="color:#2c5dcd">.</span>b64encode(data)<span style="color:#2c5dcd">.</span>decode(<span style="color:#0c6">&#39;ascii&#39;</span>))
</span></span><span style="display:flex;"><span>    socket<span style="color:#2c5dcd">.</span>send(data)
</span></span></code></pre></div><p>At end of the reference program run we dump the datagrams as JSON. If you&rsquo;re curious, here is the
<a href="https://github.com/joonas-fi/pt-p710bt-label-maker/commit/1ac56f3b8038bcc870e1cb6c8405f1ce97d46d26">full changeset</a>.</p>
<p>The choice of JSON was just a convenience in getting the data out in an interoperable format.</p>
<p>I ran the reference program successfully like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">$</span> python3 label_maker.py flatpak.png EC:79:49:...
</span></span></code></pre></div><p>NOTE: I later in Go side changed the base64 to hex representation. If I were to do it again, I would
have already done that at Python side.</p>
<h2 id="making-a-test-suite-at-go-side">Making a test suite at Go side</h2>
<p>The data from <code>sent_datagrams.json</code> gives us something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">var</span> referenceImplementationDatagrams = []<span style="color:#5918bb;font-weight:bold">string</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;1b40&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;1b6953&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;1b696101&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;1b692100&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;1b697a84001800&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;80000000&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;0000&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;1b694d&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;40&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;1b694b08&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;1b69640000&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;4d02&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;5a&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;5a&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;5a&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;5a&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;5a&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;5a&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;5a&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;5a&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0080ff;font-style:italic">// rest of lines snipped ...
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>}
</span></span></code></pre></div><p>This is all that&rsquo;s required to make tests at our new implementation side to guarantee that our
program will send the same data!</p>
<p>This might look scary (what do all those bytes mean?), but I promise it will make sense later!</p>
<p>Let&rsquo;s go one step at a time.</p>
<p>The basic structure of the reference implementation was luckily quite easy to read.
Here are all the function calls, that end up sending a datagram, marked with an arrow:</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">def</span> <span style="color:#ff8000;font-weight:bold">make_label</span>(image_path, bt_address, bt_channel):
</span></span><span style="display:flex;"><span>    data <span style="color:#2c5dcd">=</span> encode_png(image_path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#2c5dcd;font-weight:bold">with</span> bt_socket_manager(bluetooth<span style="color:#2c5dcd">.</span>RFCOMM) <span style="color:#2c5dcd;font-weight:bold">as</span> socket:
</span></span><span style="display:flex;"><span>        socket<span style="color:#2c5dcd">.</span>connect((bt_address, bt_channel))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        send_invalidate(socket)                                          <span style="color:#0080ff;font-style:italic"># &lt;--</span>
</span></span><span style="display:flex;"><span>        send_initialize(socket)                                          <span style="color:#0080ff;font-style:italic"># &lt;--</span>
</span></span><span style="display:flex;"><span>        send_status_information_request(socket)                          <span style="color:#0080ff;font-style:italic"># &lt;--</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        status_information <span style="color:#2c5dcd">=</span> receive_status_information_response(socket)
</span></span><span style="display:flex;"><span>        handle_status_information(status_information)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        send_switch_dynamic_command_mode(socket)                         <span style="color:#0080ff;font-style:italic"># &lt;--</span>
</span></span><span style="display:flex;"><span>        send_switch_automatic_status_notification_mode(socket)           <span style="color:#0080ff;font-style:italic"># &lt;--</span>
</span></span><span style="display:flex;"><span>        send_print_information_command(socket, data)                     <span style="color:#0080ff;font-style:italic"># &lt;--</span>
</span></span><span style="display:flex;"><span>        send_various_mode_settings(socket)                               <span style="color:#0080ff;font-style:italic"># &lt;--</span>
</span></span><span style="display:flex;"><span>        send_advanced_mode_settings(socket)                              <span style="color:#0080ff;font-style:italic"># &lt;--</span>
</span></span><span style="display:flex;"><span>        send_specify_margin_amount(socket)                               <span style="color:#0080ff;font-style:italic"># &lt;--</span>
</span></span><span style="display:flex;"><span>        send_select_compression_mode(socket)                             <span style="color:#0080ff;font-style:italic"># &lt;--</span>
</span></span><span style="display:flex;"><span>        send_raster_data(socket, data)                                   <span style="color:#0080ff;font-style:italic"># &lt;--</span>
</span></span><span style="display:flex;"><span>        send_print_command_with_feeding(socket)                          <span style="color:#0080ff;font-style:italic"># &lt;--</span>
</span></span></code></pre></div><p>Sidenote: the <code>receive_status_information_response()</code> receives from the socket, but we can ignore the
receive side for now and focus on the send side.
In fact the serial port doesn&rsquo;t even know if we received the data or not, so it doesn&rsquo;t matter!</p>
<p>In essence we know that output of <code>send_invalidate()</code> is one hundred zeroes.
We can at Go side make a test for that. We can also annotate the datagrams at the test suite to make
the protocol visually easier to see:</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic">// NOTE: string concatenations mean multiple datagram-writes collapsed into one
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span><span style="color:#2c5dcd;font-weight:bold">var</span> referenceImplementationDatagrams = []<span style="color:#5918bb;font-weight:bold">string</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;00000000000000000000000000000000000000000000...&#34;</span>, <span style="color:#0080ff;font-style:italic">// sendInvalidate
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	<span style="color:#0c6">&#34;1b40&#34;</span>,                                 <span style="color:#0080ff;font-style:italic">// sendInitialize
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	<span style="color:#0c6">&#34;1b6953&#34;</span>,                               <span style="color:#0080ff;font-style:italic">// sendStatusInformationRequest
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	<span style="color:#0c6">&#34;1b696101&#34;</span>,                             <span style="color:#0080ff;font-style:italic">// sendSwitchDynamicCommandMode
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	<span style="color:#0c6">&#34;1b692100&#34;</span>,                             <span style="color:#0080ff;font-style:italic">// sendSwitchAutomaticStatusNotificationMode
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	<span style="color:#0c6">&#34;1b697a84001800&#34;</span> <span style="color:#2c5dcd">+</span> <span style="color:#0c6">&#34;80000000&#34;</span> <span style="color:#2c5dcd">+</span> <span style="color:#0c6">&#34;0000&#34;</span>, <span style="color:#0080ff;font-style:italic">// sendPrintInformationCommand
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	<span style="color:#0c6">&#34;1b694d&#34;</span> <span style="color:#2c5dcd">+</span> <span style="color:#0c6">&#34;40&#34;</span>,                        <span style="color:#0080ff;font-style:italic">// sendVariousModeSettings
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	<span style="color:#0c6">&#34;1b694b08&#34;</span>,                             <span style="color:#0080ff;font-style:italic">// sendAdvancedModeSettings
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	<span style="color:#0c6">&#34;1b69640000&#34;</span>,                           <span style="color:#0080ff;font-style:italic">// sendSpecifyMarginAmount
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	<span style="color:#0c6">&#34;4d02&#34;</span>,                                 <span style="color:#0080ff;font-style:italic">// sendSelectCompressionMode
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	<span style="color:#0c6">&#34;5a&#34;</span>,                                   <span style="color:#0080ff;font-style:italic">// this and next 128 are sendRasterData
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	<span style="color:#0c6">&#34;5a&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;5a&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;5a&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;5a&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;5a&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;5a&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0c6">&#34;5a&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#0080ff;font-style:italic">// rest of lines snipped ...
</span></span></span></code></pre></div><p>It should now be starting to fit together in our head: the datagrams correlate with function outputs!</p>
<p>I also collapsed multiple datagrams into one combined datagram in functions that at reference
implementation make multiple calls to socket&rsquo;s <code>send()</code> but are actually one logical datagram:</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"># this will end up sending something like &#34;1b697a84001800800000000000&#34; (with some bytes dynamic based on `data` input)</span>
</span></span><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">def</span> <span style="color:#ff8000;font-weight:bold">send_print_information_command</span>(socket, data):
</span></span><span style="display:flex;"><span>    <span style="color:#0080ff;font-style:italic"># print to 24mm tape [1B 69 7A {84 00 18 00 &lt;data length 4 bytes&gt; 00 00}]</span>
</span></span><span style="display:flex;"><span>    socket<span style="color:#2c5dcd">.</span>send(<span style="color:#0c6">b</span><span style="color:#0c6">&#34;</span><span style="color:#c5060b;font-weight:bold">\x1B\x69\x7A\x84\x00\x18\x00</span><span style="color:#0c6">&#34;</span>)
</span></span><span style="display:flex;"><span>    socket<span style="color:#2c5dcd">.</span>send((<span style="color:#5918bb;font-weight:bold">len</span>(data) <span style="color:#2c5dcd">&gt;&gt;</span> <span style="color:#5918bb;font-weight:bold">4</span>)<span style="color:#2c5dcd">.</span>to_bytes(<span style="color:#5918bb;font-weight:bold">4</span>, <span style="color:#0c6">&#39;little&#39;</span>))
</span></span><span style="display:flex;"><span>    socket<span style="color:#2c5dcd">.</span>send(<span style="color:#0c6">b</span><span style="color:#0c6">&#34;</span><span style="color:#c5060b;font-weight:bold">\x00\x00</span><span style="color:#0c6">&#34;</span>)
</span></span></code></pre></div><p>I suspect the reason for multiple <code>send()</code> calls was ease of implementation. The serial port doesn&rsquo;t
care or see <code>send()</code> boundaries, and the term &ldquo;datagram&rdquo; that I use is somewhat imaginary concept in
this protocol since it doesn&rsquo;t have structural framing (length of datagrams are defined entirely
on &ldquo;payload&rdquo; parsing rules).</p>
<p>Now we can make a test to call our Go functions in order, that asserts that we send the same bytes:</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">func</span> <span style="color:#ff8000;font-weight:bold">TestAgainstReferenceImplementation</span>(t <span style="color:#2c5dcd">*</span>testing.T) {
</span></span><span style="display:flex;"><span>	<span style="color:#0080ff;font-style:italic">// we know that imageData in reference implementation contains raw bytes.
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	<span style="color:#0080ff;font-style:italic">// we can as a first test try to give out just null-bytes, but how many?
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	<span style="color:#0080ff;font-style:italic">// the test image we used was 128x128 pixels.
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	<span style="color:#0080ff;font-style:italic">// /8 because it&#39;s using 1-bit colors meaning one byte fits 8 pixels.
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	<span style="color:#0080ff;font-style:italic">// this was a detail I had to study the reference implementation code for.
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	<span style="color:#0080ff;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	<span style="color:#0080ff;font-style:italic">// we could of course have added logging to the reference implementation to learn that same information.
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	imageData <span style="color:#2c5dcd">:=</span> <span style="color:#5918bb;font-weight:bold">make</span>([]<span style="color:#5918bb;font-weight:bold">byte</span>, <span style="color:#5918bb;font-weight:bold">128</span><span style="color:#2c5dcd">*</span><span style="color:#5918bb;font-weight:bold">128</span><span style="color:#2c5dcd">/</span><span style="color:#5918bb;font-weight:bold">8</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#0080ff;font-style:italic">// same order as `referenceImplementationDatagrams`
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	orderOfFns <span style="color:#2c5dcd">:=</span> []<span style="color:#2c5dcd;font-weight:bold">func</span>() []<span style="color:#5918bb;font-weight:bold">byte</span>{
</span></span><span style="display:flex;"><span>		sendInvalidate,
</span></span><span style="display:flex;"><span>		sendInitialize,
</span></span><span style="display:flex;"><span>		sendStatusInformationRequest,
</span></span><span style="display:flex;"><span>		sendSwitchDynamicCommandMode,
</span></span><span style="display:flex;"><span>		sendSwitchAutomaticStatusNotificationMode,
</span></span><span style="display:flex;"><span>		<span style="color:#ff8000;font-weight:bold">sendPrintInformationCommand</span>(imageData),
</span></span><span style="display:flex;"><span>		sendVariousModeSettings,
</span></span><span style="display:flex;"><span>		sendAdvancedModeSettings,
</span></span><span style="display:flex;"><span>		sendSpecifyMarginAmount,
</span></span><span style="display:flex;"><span>		sendSelectCompressionMode, <span style="color:#0080ff;font-style:italic">// datagramIdx==9
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>
</span></span><span style="display:flex;"><span>		<span style="color:#0080ff;font-style:italic">// we don&#39;t want to repeat 128 times `sendRasterData` here, so it&#39;ll be explicitly handled by the code below
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>
</span></span><span style="display:flex;"><span>		<span style="color:#0080ff;font-style:italic">// sendRasterData(imageData), // for phases 10 onwards for the next 128 datagrams
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>		<span style="color:#0080ff;font-style:italic">// sendPrintCommandWithFeeding, // last one
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	makeDatagram <span style="color:#2c5dcd">:=</span> <span style="color:#2c5dcd;font-weight:bold">func</span>(imageData []<span style="color:#5918bb;font-weight:bold">byte</span>, datagramIdx <span style="color:#5918bb;font-weight:bold">int</span>) []<span style="color:#5918bb;font-weight:bold">byte</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#2c5dcd;font-weight:bold">switch</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#2c5dcd;font-weight:bold">case</span> datagramIdx &lt; <span style="color:#5918bb;font-weight:bold">len</span>(orderOfFns):
</span></span><span style="display:flex;"><span>			<span style="color:#2c5dcd;font-weight:bold">return</span> orderOfFns[datagramIdx]()
</span></span><span style="display:flex;"><span>		<span style="color:#2c5dcd;font-weight:bold">case</span> datagramIdx &lt; <span style="color:#5918bb;font-weight:bold">len</span>(orderOfFns)<span style="color:#2c5dcd">+</span><span style="color:#5918bb;font-weight:bold">128</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#2c5dcd;font-weight:bold">return</span> <span style="color:#ff8000;font-weight:bold">sendRasterData</span>(imageData, datagramIdx<span style="color:#2c5dcd">-</span><span style="color:#5918bb;font-weight:bold">len</span>(orderOfFns))
</span></span><span style="display:flex;"><span>		<span style="color:#2c5dcd;font-weight:bold">default</span>: <span style="color:#0080ff;font-style:italic">// last one
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>			<span style="color:#2c5dcd;font-weight:bold">return</span> <span style="color:#ff8000;font-weight:bold">sendPrintCommandWithFeeding</span>()
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#2c5dcd;font-weight:bold">for</span> i <span style="color:#2c5dcd">:=</span> <span style="color:#5918bb;font-weight:bold">0</span>; i &lt; <span style="color:#5918bb;font-weight:bold">len</span>(referenceImplementationDatagrams); i<span style="color:#2c5dcd">++</span> {
</span></span><span style="display:flex;"><span>		sentByUs <span style="color:#2c5dcd">:=</span> <span style="color:#ff8000;font-weight:bold">makeDatagram</span>(imageData, i)
</span></span><span style="display:flex;"><span>		sentByReferenceImplementation, err <span style="color:#2c5dcd">:=</span> hex.<span style="color:#ff8000;font-weight:bold">DecodeString</span>(referenceImplementationDatagrams[i])
</span></span><span style="display:flex;"><span>		assert.<span style="color:#ff8000;font-weight:bold">Ok</span>(t, err)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#2c5dcd;font-weight:bold">if</span> !bytes.<span style="color:#ff8000;font-weight:bold">Equal</span>(sentByUs, sentByReferenceImplementation) {
</span></span><span style="display:flex;"><span>			t.<span style="color:#ff8000;font-weight:bold">Errorf</span>(<span style="color:#0c6">&#34;datagram[%d]: %x (ref) %x (us)&#34;</span>, i, sentByReferenceImplementation, sentByUs)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can get the test suite to compile by defining stubs:</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">var</span> (
</span></span><span style="display:flex;"><span>	sendInvalidate                            = unimplemented
</span></span><span style="display:flex;"><span>	sendInitialize                            = unimplemented
</span></span><span style="display:flex;"><span>	sendPrintCommandWithFeeding               = unimplemented
</span></span><span style="display:flex;"><span>	sendStatusInformationRequest              = unimplemented
</span></span><span style="display:flex;"><span>	sendSwitchDynamicCommandMode              = unimplemented
</span></span><span style="display:flex;"><span>	sendSwitchAutomaticStatusNotificationMode = unimplemented
</span></span><span style="display:flex;"><span>	sendVariousModeSettings                   = unimplemented
</span></span><span style="display:flex;"><span>	sendAdvancedModeSettings                  = unimplemented
</span></span><span style="display:flex;"><span>	sendSpecifyMarginAmount                   = unimplemented
</span></span><span style="display:flex;"><span>	sendSelectCompressionMode                 = unimplemented
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic">// these below two functions have output that depends on input
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">func</span> <span style="color:#ff8000;font-weight:bold">sendPrintInformationCommand</span>(imageData []<span style="color:#5918bb;font-weight:bold">byte</span>) <span style="color:#2c5dcd;font-weight:bold">func</span>() []<span style="color:#5918bb;font-weight:bold">byte</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#2c5dcd;font-weight:bold">return</span> <span style="color:#2c5dcd;font-weight:bold">func</span>() []<span style="color:#5918bb;font-weight:bold">byte</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#2c5dcd;font-weight:bold">return</span> <span style="color:#2c5dcd;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">func</span> <span style="color:#ff8000;font-weight:bold">sendRasterData</span>(imageData []<span style="color:#5918bb;font-weight:bold">byte</span>, chunkIdx <span style="color:#5918bb;font-weight:bold">int</span>) []<span style="color:#5918bb;font-weight:bold">byte</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#2c5dcd;font-weight:bold">return</span> <span style="color:#2c5dcd;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">func</span> <span style="color:#ff8000;font-weight:bold">unimplemented</span>() []<span style="color:#5918bb;font-weight:bold">byte</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#2c5dcd;font-weight:bold">return</span> <span style="color:#2c5dcd;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now the test suite compiles.</p>
<h2 id="making-the-first-tests-pass">Making the first tests pass</h2>
<p>Now running tests we get:</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#aaa">main_test.go:79: datagram[0]: 0000000000000... (ref)  (us)
</span></span></span></code></pre></div><p>It tells us that for very first datagram we should return hundred zeroes but we&rsquo;re returning nothing.</p>
<p>Let&rsquo;s fix the first two datagrams by replacing the stubs with better implementations:</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">func</span> <span style="color:#ff8000;font-weight:bold">sendInvalidate</span>() []<span style="color:#5918bb;font-weight:bold">byte</span> {
</span></span><span style="display:flex;"><span>	hundredZeroBytes <span style="color:#2c5dcd">:=</span> <span style="color:#5918bb;font-weight:bold">make</span>([]<span style="color:#5918bb;font-weight:bold">byte</span>, <span style="color:#5918bb;font-weight:bold">100</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#2c5dcd;font-weight:bold">return</span> hundredZeroBytes
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic">// from docs:
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic">// &gt; Initializes mode settings.
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span><span style="color:#2c5dcd;font-weight:bold">func</span> <span style="color:#ff8000;font-weight:bold">sendInitialize</span>() []<span style="color:#5918bb;font-weight:bold">byte</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#2c5dcd;font-weight:bold">return</span> []<span style="color:#5918bb;font-weight:bold">byte</span>{<span style="color:#5918bb;font-weight:bold">0x1b</span>, <span style="color:#5918bb;font-weight:bold">0x40</span>}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now the tests only fail from the 3rd datagram forward.
It&rsquo;s easy to look at the expected datagrams while looking at the reference implementation (and if
in doubt, also looking at the protocol documentation if that is available).</p>
<p>The first dynamic and non-obvious function to implement from the reference implementation:</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">def</span> <span style="color:#ff8000;font-weight:bold">send_print_information_command</span>(socket, data):
</span></span><span style="display:flex;"><span>    <span style="color:#0080ff;font-style:italic"># print to 24mm tape [1B 69 7A {84 00 18 00 &lt;data length 4 bytes&gt; 00 00}]</span>
</span></span><span style="display:flex;"><span>    socket<span style="color:#2c5dcd">.</span>send(<span style="color:#0c6">b</span><span style="color:#0c6">&#34;</span><span style="color:#c5060b;font-weight:bold">\x1B\x69\x7A\x84\x00\x18\x00</span><span style="color:#0c6">&#34;</span>)
</span></span><span style="display:flex;"><span>    socket<span style="color:#2c5dcd">.</span>send((<span style="color:#5918bb;font-weight:bold">len</span>(data) <span style="color:#2c5dcd">&gt;&gt;</span> <span style="color:#5918bb;font-weight:bold">4</span>)<span style="color:#2c5dcd">.</span>to_bytes(<span style="color:#5918bb;font-weight:bold">4</span>, <span style="color:#0c6">&#39;little&#39;</span>))
</span></span><span style="display:flex;"><span>    socket<span style="color:#2c5dcd">.</span>send(<span style="color:#0c6">b</span><span style="color:#0c6">&#34;</span><span style="color:#c5060b;font-weight:bold">\x00\x00</span><span style="color:#0c6">&#34;</span>)
</span></span></code></pre></div><p>It isn&rsquo;t quite explaining why it&rsquo;s shifting the length of the data by four, but anyway let&rsquo;s go on.
The <code>'little'</code> hints us that we use little-endian encoding:</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">func</span> <span style="color:#ff8000;font-weight:bold">sendPrintInformationCommand</span>(imageData []<span style="color:#5918bb;font-weight:bold">byte</span>) <span style="color:#2c5dcd;font-weight:bold">func</span>() []<span style="color:#5918bb;font-weight:bold">byte</span> {
</span></span><span style="display:flex;"><span>	dataLenShiftedByFour <span style="color:#2c5dcd">:=</span> <span style="color:#5918bb;font-weight:bold">len</span>(imageData) <span style="color:#2c5dcd">&gt;&gt;</span> <span style="color:#5918bb;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#0080ff;font-style:italic">// print to 24mm tape [1B 69 7A {84 00 18 00 &lt;data length 4 bytes&gt; 00 00}]
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	<span style="color:#2c5dcd;font-weight:bold">return</span> <span style="color:#2c5dcd;font-weight:bold">func</span>() []<span style="color:#5918bb;font-weight:bold">byte</span> {
</span></span><span style="display:flex;"><span>		msg <span style="color:#2c5dcd">:=</span> []<span style="color:#5918bb;font-weight:bold">byte</span>{<span style="color:#5918bb;font-weight:bold">0x1B</span>, <span style="color:#5918bb;font-weight:bold">0x69</span>, <span style="color:#5918bb;font-weight:bold">0x7A</span>, <span style="color:#5918bb;font-weight:bold">0x84</span>, <span style="color:#5918bb;font-weight:bold">0x00</span>, <span style="color:#5918bb;font-weight:bold">0x18</span>, <span style="color:#5918bb;font-weight:bold">0x00</span>}
</span></span><span style="display:flex;"><span>		msg = binary.LittleEndian.<span style="color:#ff8000;font-weight:bold">AppendUint32</span>(msg, <span style="color:#5918bb;font-weight:bold">uint32</span>(dataLenShiftedByFour))
</span></span><span style="display:flex;"><span>		msg = <span style="color:#5918bb;font-weight:bold">append</span>(msg, <span style="color:#5918bb;font-weight:bold">0x00</span>, <span style="color:#5918bb;font-weight:bold">0x00</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#2c5dcd;font-weight:bold">return</span> msg
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This datagram test now passes.</p>
<h2 id="fixing-the-rest-of-the-tests">Fixing the rest of the tests</h2>
<p>Now the next failure is the 11th datagram. It is the first <code>5a</code> i.e. the first datagram produced by <code>sendRasterData()</code>.</p>
<p>The reference looks quite intimidating:</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">def</span> <span style="color:#ff8000;font-weight:bold">send_raster_data</span>(socket, data):
</span></span><span style="display:flex;"><span>    <span style="color:#0080ff;font-style:italic"># send all raster data lines</span>
</span></span><span style="display:flex;"><span>    <span style="color:#2c5dcd;font-weight:bold">for</span> line <span style="color:#2c5dcd;font-weight:bold">in</span> rasterize(data):
</span></span><span style="display:flex;"><span>        socket<span style="color:#2c5dcd">.</span>send(<span style="color:#5918bb;font-weight:bold">bytes</span>(line))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"># (these come from separate file - I&#39;m summarizing here)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CHUNK_SIZE <span style="color:#2c5dcd">=</span> <span style="color:#5918bb;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span>ZERO_CHUNK <span style="color:#2c5dcd">=</span> <span style="color:#5918bb;font-weight:bold">bytearray</span>(<span style="color:#0c6">b</span><span style="color:#0c6">&#34;</span><span style="color:#c5060b;font-weight:bold">\x00</span><span style="color:#0c6">&#34;</span> <span style="color:#2c5dcd">*</span> CHUNK_SIZE)
</span></span><span style="display:flex;"><span>ZERO_COMMAND <span style="color:#2c5dcd">=</span> <span style="color:#0c6">b</span><span style="color:#0c6">&#34;</span><span style="color:#c5060b;font-weight:bold">\x5A</span><span style="color:#0c6">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">def</span> <span style="color:#ff8000;font-weight:bold">rasterize</span>(encoded_image_data):
</span></span><span style="display:flex;"><span>    <span style="color:#2c5dcd;font-weight:bold">for</span> i <span style="color:#2c5dcd;font-weight:bold">in</span> <span style="color:#5918bb;font-weight:bold">range</span>(<span style="color:#5918bb;font-weight:bold">0</span>, <span style="color:#5918bb;font-weight:bold">len</span>(encoded_image_data), CHUNK_SIZE):
</span></span><span style="display:flex;"><span>        buffer <span style="color:#2c5dcd">=</span> <span style="color:#5918bb;font-weight:bold">bytearray</span>()
</span></span><span style="display:flex;"><span>        chunk <span style="color:#2c5dcd">=</span> encoded_image_data[i:i <span style="color:#2c5dcd">+</span> CHUNK_SIZE]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#2c5dcd;font-weight:bold">if</span> chunk <span style="color:#2c5dcd">==</span> ZERO_CHUNK:
</span></span><span style="display:flex;"><span>            buffer <span style="color:#2c5dcd">+=</span> ZERO_COMMAND
</span></span><span style="display:flex;"><span>        <span style="color:#2c5dcd;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            packed_chunk <span style="color:#2c5dcd">=</span> packbits<span style="color:#2c5dcd">.</span>encode(chunk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            buffer <span style="color:#2c5dcd">+=</span> RASTER_COMMAND
</span></span><span style="display:flex;"><span>            buffer <span style="color:#2c5dcd">+=</span> <span style="color:#5918bb;font-weight:bold">len</span>(packed_chunk)<span style="color:#2c5dcd">.</span>to_bytes(<span style="color:#5918bb;font-weight:bold">2</span>, <span style="color:#0c6">&#34;little&#34;</span>)
</span></span><span style="display:flex;"><span>            buffer <span style="color:#2c5dcd">+=</span> packbits<span style="color:#2c5dcd">.</span>encode(chunk)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#2c5dcd;font-weight:bold">yield</span> buffer
</span></span></code></pre></div><p>At reference side this is called once and it sends 128 datagrams.
It looks to be for every 16 bytes of image raw data either emitting a &ldquo;zero command&rdquo; or a compressed chunk.</p>
<p>At Go side, for testability, we modeled this <code>sendRasterData()</code> to be called once for each expected
datagram, varying its input on <code>chunkIdx</code> so the looping is done <em>by the caller instead</em>.</p>
<p>Since the code looks to be at some times outputting the &ldquo;zero command&rdquo; and it looks to be doing that
when the bytes are all zeroes, we can handle that and leave the compression still stubbed out:</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">const</span> chunkLen = <span style="color:#5918bb;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic">// this is where the image data is sent
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span><span style="color:#2c5dcd;font-weight:bold">func</span> <span style="color:#ff8000;font-weight:bold">sendRasterData</span>(imageData []<span style="color:#5918bb;font-weight:bold">byte</span>, chunkIdx <span style="color:#5918bb;font-weight:bold">int</span>) []<span style="color:#5918bb;font-weight:bold">byte</span> {
</span></span><span style="display:flex;"><span>	chunk <span style="color:#2c5dcd">:=</span> imageData[chunkLen<span style="color:#2c5dcd">*</span>chunkIdx : chunkLen<span style="color:#2c5dcd">*</span>chunkIdx<span style="color:#2c5dcd">+</span>chunkLen]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#2c5dcd;font-weight:bold">if</span> <span style="color:#ff8000;font-weight:bold">byteSliceAllZeroes</span>(chunk) { <span style="color:#0080ff;font-style:italic">// chunk all black pixels?
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>		<span style="color:#2c5dcd;font-weight:bold">return</span> []<span style="color:#5918bb;font-weight:bold">byte</span>{<span style="color:#5918bb;font-weight:bold">0x5a</span>} <span style="color:#0080ff;font-style:italic">// zero command
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	} <span style="color:#2c5dcd;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#2c5dcd;font-weight:bold">return</span> <span style="color:#2c5dcd;font-weight:bold">nil</span> <span style="color:#0080ff;font-style:italic">// TODO: implement compression
</span></span></span><span style="display:flex;"><span><span style="color:#0080ff;font-style:italic"></span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">func</span> <span style="color:#ff8000;font-weight:bold">byteSliceAllZeroes</span>(b []<span style="color:#5918bb;font-weight:bold">byte</span>) <span style="color:#5918bb;font-weight:bold">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#2c5dcd;font-weight:bold">for</span> _, item <span style="color:#2c5dcd">:=</span> <span style="color:#2c5dcd;font-weight:bold">range</span> b {
</span></span><span style="display:flex;"><span>		<span style="color:#2c5dcd;font-weight:bold">if</span> item <span style="color:#2c5dcd">!=</span> <span style="color:#5918bb;font-weight:bold">0x00</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#2c5dcd;font-weight:bold">return</span> <span style="color:#2c5dcd;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#2c5dcd;font-weight:bold">return</span> <span style="color:#2c5dcd;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>How far does that get us? Let&rsquo;s see:</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#aaa">main_test.go:73: datagram[43]: 470800fd00fdff0080fa00 (ref) 5a (us)
</span></span></span></code></pre></div><p>So our implementation &ldquo;sent&rdquo; 43 datagrams successfully and only then encountered a mismatch compared
to the reference implementation! Datagram-wise our progress is 43/139 i.e. 30 %! Pretty nice.</p>
<p>33 of those 43 datagrams were actually already image data (those <code>5a</code> datagrams) so looks like we
got lucky by guessing we could give null bytes as the <code>imageData</code> and our test image just happened
to contain black pixels (as sent by the reference implementation) only closer to center of the image
(which means later in the datagram order):</p>
<p><img src="quiet-area.png" alt=""></p>
<p>Red rectangle denotes the quiet area. We know from looking at the reference implementation that it
rotates the image first so left side becomes the top side in the datagram order.</p>
<p>I next had the task of actually loading the test image as PNG (instead of giving null bytes for the
image data) and then implementing the pixel compression.</p>
<p>However those are not relevant to this article as I hope the basic principle has been demonstrated
enough already. ðŸ™‚</p>
<p>Implementing those features was quite straightforward and it made the tests pass.</p>
<h2 id="result-working-prints">Result: working prints</h2>
<p>After the tests passed for the first time, using my implementation to print to the printer worked
on the first try. ðŸŽ‰</p>
<p><img src="label-comparison.jpg" alt=""></p>
<p>Above is the reference implementation print, below is my implementation.</p>
<p>p.s. don&rsquo;t mind the clipping, as the reference implementation forces 128 px height for the picture
and my printer doesn&rsquo;t seem to print the full 128 px height.
I guess the print area (or resolution) is smaller in my printer compared to the exact printer that
the reference implementation supports. I will now have quite easy time in fixing it now that I have working baseline.</p>
<h2 id="summary">Summary</h2>
<p>We went over an approach to capture known-good datagrams from a reference implementation and then
have a test suite guide us in implementing bit-exact (protocol-level) replica of the new implementation.</p>
<p>A nice property is that we had to only run the reference program once.
After the datagram set was captured, it&rsquo;s mainly working with that from then on.
Of course looking at the reference implementation code helps to understand the message contents beyond
plain bytes, but no re-runs are needed.</p>
<p>This same approach has helped me quite many times in my career in different situations.</p>
<p>The approach can be, if needed, applied to larger amounts of data as well, but then you might want
to work with digests instead of raw byte content then.</p>
<h2 id="sidetalk-why-not-extend-the-original-implementation">Sidetalk: why not extend the original implementation?</h2>
<p>Dependencies (Go is better for zero-dependencies binaries) and I wanted to also add quite many
features (barcodes, HTTP API etc.).</p>
<p>You&rsquo;ll find better rationale (and the resulting implementation) here: <a href="https://github.com/joonas-fi/bro">https://github.com/joonas-fi/bro</a></p>

    </div>
	<div class="post-footer">
		<hr />

		<img src="/signature.png" alt="signature" style="height: 55px;" />

		<p>Thanks for reading! <span style="font-style: normal;">ðŸ˜</span></p>
		<p>
			If you like my writing, consider following me on
			<a href="https://twitter.com/joonas_fi">Twitter</a>.
		</p>

		<p>
			Stay updated on my blog posts &amp; projects - sign up for
			<a href="https://buttondown.email/joonas">my newsletter</a>. ðŸš€
			<br />
			<small>
				No spam, unsubscribe any time.
				<a href="/feed.xml">RSS</a> also available.
			</small>
		</p>
	</div>
  </article>

  <hr />

  
<div id="disqus_thread"></div>
<script type="text/javascript">

var disqus_identifier = '\/2023\/03\/an-approach-to-protocol-reverse-engineering';

(function() {
   if (window.location.hostname.indexOf('.dev.fn61.net') != -1) {
        document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
        return;
    }

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'joonas-fi';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  
  

  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/today-i-learned/">Today I Learned</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/contact/">Contact</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#the-idea">The idea</a></li>
    <li><a href="#capturing-sent-data-from-the-reference-implementation">Capturing sent data from the reference implementation</a></li>
    <li><a href="#making-a-test-suite-at-go-side">Making a test suite at Go side</a></li>
    <li><a href="#making-the-first-tests-pass">Making the first tests pass</a></li>
    <li><a href="#fixing-the-rest-of-the-tests">Fixing the rest of the tests</a></li>
    <li><a href="#result-working-prints">Result: working prints</a></li>
    <li><a href="#summary">Summary</a></li>
    <li><a href="#sidetalk-why-not-extend-the-original-implementation">Sidetalk: why not extend the original implementation?</a></li>
  </ul>
</nav>
    </div>

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f&text=An%20approach%20to%20protocol%20reverse-engineering">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f&title=An%20approach%20to%20protocol%20reverse-engineering">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f&is_video=false&description=An%20approach%20to%20protocol%20reverse-engineering">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=An%20approach%20to%20protocol%20reverse-engineering&body=Check out this article: https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f&title=An%20approach%20to%20protocol%20reverse-engineering">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f&title=An%20approach%20to%20protocol%20reverse-engineering">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f&title=An%20approach%20to%20protocol%20reverse-engineering">
      <i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f&title=An%20approach%20to%20protocol%20reverse-engineering">
      <i class="fab fa-digg fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f&name=An%20approach%20to%20protocol%20reverse-engineering&description=This%20basic%20principle%20has%20worked%20for%20me%20many%20times%2c%20so%20I%20figured%20it%20might%20be%20worth%20to%20share%20the%20process.%0aIn%20this%20instance%20I%20wanted%20to%20write%20a%20label%20printer%20driver%20in%20Go.%20A%20barebones%20implementation%20exists%20in%20Python%20that%20works%20to%20print%20a%20test%20image.%0aThe%20idea%20If%20I%20can%20reach%20parity%20with%20the%20Python-based%20implementation%20%28from%20now%20on%20referred%20to%20as%20the%20reference%20implementation%29%2c%20I%20can%20build%20on%20top%20of%20a%20working%20baseline.">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fjoonas.fi%2f2023%2f03%2fan-approach-to-protocol-reverse-engineering%2f&t=An%20approach%20to%20protocol%20reverse-engineering">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2023  joonas.fi 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/today-i-learned/">Today I Learned</a></li>
         
        <li><a href="/about/">About</a></li>
         
        <li><a href="/contact/">Contact</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>



</html>
