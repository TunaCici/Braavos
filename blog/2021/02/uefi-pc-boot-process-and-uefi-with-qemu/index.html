<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> UEFI, PC boot process and UEFI with QEMU | joonas.fi</title>
  <meta name="description" content="Let‚Äôs get to work ·ïï( ·êõ )·ïó">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="UEFI, PC boot process and UEFI with QEMU" />
<meta property="og:description" content="Recently I learned a lot more about UEFI/BIOS than I would&rsquo;ve liked to, when I was configuring my new exotic system&rsquo;s boot process. It just goes to show you that when you step away from the well-traveled path, you&rsquo;re going to run into stupid problems and have to understand deeper about how things work. So I&rsquo;m sharing what I learned.
Legacy BIOS To better understand UEFI, we must first dig into a little bit of history." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://joonas.fi/2021/02/uefi-pc-boot-process-and-uefi-with-qemu/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-02-18T08:00:00+00:00" />
<meta property="article:modified_time" content="2021-02-18T08:00:00+00:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="UEFI, PC boot process and UEFI with QEMU"/>
<meta name="twitter:description" content="Recently I learned a lot more about UEFI/BIOS than I would&rsquo;ve liked to, when I was configuring my new exotic system&rsquo;s boot process. It just goes to show you that when you step away from the well-traveled path, you&rsquo;re going to run into stupid problems and have to understand deeper about how things work. So I&rsquo;m sharing what I learned.
Legacy BIOS To better understand UEFI, we must first dig into a little bit of history."/>

  
  
  
  <link rel="stylesheet" href="/css/style-white.css">
  
   <link rel="stylesheet" href="/css/custom.css"> 
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  <link rel="icon" type="image/png" href="/favicon.ico" />
  
  
  
  
  
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-24122659-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/today-i-learned/">Today I Learned</a></li>
         
        <li><a href="/about/">About</a></li>
         
        <li><a href="/contact/">Contact</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://joonas.fi/2021/02/reverse-engineering-midi-devices-akai-mpk-mini-mk3/">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://joonas.fi/2021/02/blog-facelift-technical-renovation/">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f&text=UEFI%2c%20PC%20boot%20process%20and%20UEFI%20with%20QEMU">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f&title=UEFI%2c%20PC%20boot%20process%20and%20UEFI%20with%20QEMU">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f&is_video=false&description=UEFI%2c%20PC%20boot%20process%20and%20UEFI%20with%20QEMU">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=UEFI%2c%20PC%20boot%20process%20and%20UEFI%20with%20QEMU&body=Check out this article: https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f&title=UEFI%2c%20PC%20boot%20process%20and%20UEFI%20with%20QEMU">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f&title=UEFI%2c%20PC%20boot%20process%20and%20UEFI%20with%20QEMU">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f&title=UEFI%2c%20PC%20boot%20process%20and%20UEFI%20with%20QEMU">
      <i class="fab fa-stumbleupon " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f&title=UEFI%2c%20PC%20boot%20process%20and%20UEFI%20with%20QEMU">
      <i class="fab fa-digg " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f&name=UEFI%2c%20PC%20boot%20process%20and%20UEFI%20with%20QEMU&description=Recently%20I%20learned%20a%20lot%20more%20about%20UEFI%2fBIOS%20than%20I%20would%26rsquo%3bve%20liked%20to%2c%20when%20I%20was%20configuring%20my%20new%20exotic%20system%26rsquo%3bs%20boot%20process.%20It%20just%20goes%20to%20show%20you%20that%20when%20you%20step%20away%20from%20the%20well-traveled%20path%2c%20you%26rsquo%3bre%20going%20to%20run%20into%20stupid%20problems%20and%20have%20to%20understand%20deeper%20about%20how%20things%20work.%20So%20I%26rsquo%3bm%20sharing%20what%20I%20learned.%0aLegacy%20BIOS%20To%20better%20understand%20UEFI%2c%20we%20must%20first%20dig%20into%20a%20little%20bit%20of%20history.">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f&t=UEFI%2c%20PC%20boot%20process%20and%20UEFI%20with%20QEMU">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#legacy-bios">Legacy BIOS</a>
      <ul>
        <li><a href="#bios-as-a-standard">BIOS as a standard</a></li>
        <li><a href="#bios-as-the-implementation">BIOS as the implementation</a></li>
        <li><a href="#how-a-bios-works">How a BIOS works</a></li>
        <li><a href="#limitations-of-legacy-bios">Limitations of legacy BIOS</a></li>
        <li><a href="#legacy-bios-boot-process">Legacy BIOS boot process</a></li>
      </ul>
    </li>
    <li><a href="#modern-times-uefi">Modern times: UEFI</a>
      <ul>
        <li><a href="#why-do-we-need-uefi">Why do we need UEFI?</a></li>
        <li><a href="#uefi-is-not-bios">UEFI is not BIOS</a></li>
        <li><a href="#efi-system-partition">EFI system partition</a></li>
        <li><a href="#efi-variables">EFI variables</a></li>
        <li><a href="#boot-process-with-efi">Boot process with EFI</a></li>
        <li><a href="#linux-efi-stub">Linux EFI stub</a></li>
        <li><a href="#implications-of-efi-variables">Implications of EFI variables</a></li>
      </ul>
    </li>
    <li><a href="#qemu-and-uefi">QEMU and UEFI</a>
      <ul>
        <li><a href="#built-in-boot-modes">Built-in boot modes</a></li>
        <li><a href="#qemu-and-uefi-boot">QEMU and UEFI boot</a></li>
        <li><a href="#managing-boot-options-from-os">Managing boot options from OS</a></li>
        <li><a href="#finding-working-firmware-and-efi-vars-file">Finding working firmware and EFI vars file</a></li>
        <li><a href="#troubleshooting">Troubleshooting</a></li>
      </ul>
    </li>
    <li><a href="#why-is-everything-so-hard">Why is everything so hard?</a>
      <ul>
        <li><a href="#my-troubles-with-uefi">My troubles with UEFI</a></li>
        <li><a href="#my-troubles-with-bootloaders">My troubles with bootloaders</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
  </span>
</div>

<div class="alert-warning">
	üö®
	<a href="https://www.reuters.com/world/europe/icc-says-may-investigate-possible-war-crimes-after-russian-invasion-ukraine-2022-02-25/">Putin is a war criminal</a>.
	<a href="https://arstechnica.com/science/2022/03/russia-attacked-ukrainian-hospitals-violating-humanitarian-law-who-says/">Russians are bombing hospitals</a>.
	üíîüá∫üá¶
</div>



  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
    

      <h1 class="posttitle" itemprop="name headline">
        UEFI, PC boot process and UEFI with QEMU
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2021-02-18 08:00:00 &#43;0000 UTC" itemprop="datePublished">2021-02-18</time>
          
        </div>
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/tags/technology/" rel="tag">technology</a>
            
        </div>
        
      </div>
    </header>

  
    <div class="content" itemprop="articleBody">
      <p>Recently I learned a lot more about UEFI/BIOS than I would&rsquo;ve liked to, when I was configuring
<a href="https://github.com/joonas-fi/joonas-sys/">my new exotic system</a>&rsquo;s boot process. It just goes to show
you that when you step away from the well-traveled path, you&rsquo;re going to run into stupid problems
and have to understand deeper about how things work. So I&rsquo;m sharing what I learned.</p>
<h2 id="legacy-bios">Legacy BIOS</h2>
<p>To better understand UEFI, we must first dig into a little bit of history. Computers since the 1980s
have been using <a href="https://en.wikipedia.org/wiki/BIOS">BIOS</a>.</p>
<p>When we speak of BIOS, depending on context we mean different things:</p>
<ul>
<li>BIOS the standard</li>
<li>Concrete BIOS implementation - the motherboard-specific firmware (&ldquo;ASUS $motherboard_name BIOS&rdquo;)
<ul>
<li>= Code written or licensed by the motherboard manufacturer</li>
</ul>
</li>
</ul>
<p>When the computer powers on, the hardware is set up to start executing BIOS. That is all the CPU has to
know about, i.e. the CPU doesn&rsquo;t have to understand about drives, filesystems or operating systems.</p>
<h3 id="bios-as-a-standard">BIOS as a standard</h3>
<p>As a standard it defines:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Reset_vector">A hardcoded memory location</a> where on power-on the CPU
will begin executing BIOS code from.</li>
<li>Disk locations where OS manufacturers can place their bootloaders to get their OS started</li>
<li><a href="https://wiki.osdev.org/BIOS#Common_functions">APIs</a> for:
<ul>
<li>reading/writing data from/to hard disks and floppies (so not all programs have to deal with IDE/SATA/etc buses directly)</li>
<li>reading keyboard keystrokes</li>
<li>=&gt; BIOS is a hardware abstraction layer.</li>
</ul>
</li>
<li>Many things more</li>
</ul>
<p>In these ways, BIOS is an API for:</p>
<ul>
<li>OS manufacturers</li>
<li>CPU manufacturers</li>
<li>Application developers. Though not much use nowadays because:
<ul>
<li>Developers interact with OS hardware abstraction APIs and even OS themselves don&rsquo;t use much BIOS APIs (since they control hardware directly for lower-level access)</li>
<li>Even in DOS times application developers probably used DOS APIs for abstraction instead of BIOS directly</li>
</ul>
</li>
</ul>
<h3 id="bios-as-the-implementation">BIOS as the implementation</h3>
<p>You might be familiar with updating your motherboard BIOS.
The BIOS-to-be-flashed is motherboard specific (i.e. there&rsquo;s no single BIOS that works for all motherboards),
because BIOS-the-implementation is motherboard specific.</p>
<p>I don&rsquo;t know everything there is specific to the manufacturer, but one thing I guess is different
<a href="https://en.wikipedia.org/wiki/Chipset#Computers">motherboard chipsets</a>, such as initializing/handling
memory controllers, built-in graphics etc.</p>
<h3 id="how-a-bios-works">How a BIOS works</h3>
<p>x86 CPU is defined to start executing code from a hardcoded memory location
(<a href="https://stackoverflow.com/questions/7804724/how-is-the-bios-rom-mapped-into-address-space-on-pc">0xFFFFFFF0</a>).
This memory location is backed by the motherboard&rsquo;s BIOS code ROM.
It is quite easy to electrically separate different address spaces where certain locations are
read from RAM and certain locations from BIOS ROM etc.
For a deeper dive into the concept electrically, <a href="https://www.youtube.com/watch?v=2iURr3NBprc">watch this video</a>.</p>
<p>Here&rsquo;s an oversimplified view:</p>
<p><img src="uefi-pc-memory-view.png" alt=""></p>
<p>The BIOS is responsible for
actually booting your OS.</p>
<p>In your BIOS settings you usually could configure the boot order like CD-ROM, Hard drive 1, Hard drive 2
etc, and any combinations thereof.
BIOS would find the first bootable item from your boot order preferences.</p>
<h3 id="limitations-of-legacy-bios">Limitations of legacy BIOS</h3>
<p>Most operating systems had to use a complicated chained boot process due to bootloader size limitations.</p>
<h3 id="legacy-bios-boot-process">Legacy BIOS boot process</h3>
<p>With hard drives there exists a <a href="https://en.wikipedia.org/wiki/Boot_sector">boot sector</a>.
The boot sector, or more specifically <a href="https://en.wikipedia.org/wiki/Master_boot_record#Sector_layout">MBR</a>
(Master Boot Record),
contains the bootloader and its size limitation is effectively <a href="https://unix.stackexchange.com/a/254668">440 bytes</a>,
so there&rsquo;s zero chance a bootloader that size alone can load a modern operating system.</p>
<p>Usually the MBR&rsquo;s bootloader passes control to the active partition&rsquo;s bootloader
(<a href="https://en.wikipedia.org/wiki/Volume_boot_record">VBR</a>, Volume Boot Record), but it has the same size limitation.</p>
<p>Loading an OS at minimum means that the bootloader has to read the kernel (Linux/Windows/etc.)
from disk and give control to it.
The kernel is much wiser, and can understand various filesystems like NTFS/FAT etc.
But for the bootloader to read the kernel from the disk, it would have to know how to traverse the filesystem
to access the kernel.
For this reason, the bootloader reads and chainloads a
<a href="https://wiki.osdev.org/Bootloader#Two-Stage_Bootloader">&ldquo;second stage&rdquo;</a> from the root of the filesystem
(a much simpler task) - a file which can be larger and therefore can contain more complicated code.</p>
<p>In Windows this second stage used to be called <a href="https://en.wikipedia.org/wiki/NTLDR">NTLDR</a>
(&ldquo;NT loader&rdquo;) and was at the root of your <code>C:</code> drive.</p>
<p><img src="uefi-ntldr.png" alt=""></p>
<p>Here&rsquo;s about the boot process with legacy BIOS and an older Windows version:</p>
<p><img src="uefi-legacy-bios-boot-process.png" alt=""></p>
<p>As you can see, there&rsquo;s quite a lot of arrows - the bootloader components are spread out all
over the place. Three different Windows-specific places for starting to load the actual kernel.
All it takes is for one of the pieces to get borked and you&rsquo;ll end up with non-bootable system.</p>
<p>It&rsquo;s roughly the same for Linux (chained GRUB bootloader stages).</p>
<h2 id="modern-times-uefi">Modern times: UEFI</h2>
<h3 id="why-do-we-need-uefi">Why do we need UEFI?</h3>
<p>Due to limitations of the legacy BIOS, a new standard was developed, called
<a href="https://en.wikipedia.org/wiki/Unified_Extensible_Firmware_Interface">UEFI</a> (often shortened to &ldquo;EFI&rdquo;).
UEFI does the same things a legacy BIOS used to do (and more), but the interfaces (standard, &ldquo;the API&rdquo;)
are different.</p>
<p>Instead of tiny bootsectors we now have a dedicated partition large enough to contain the whole
operating system bootloader so we don&rsquo;t have to chain multiple parts together.</p>
<p>UEFI also gives us network booting, security like
<a href="https://en.wikipedia.org/wiki/Unified_Extensible_Firmware_Interface#SECURE-BOOT">secure boot</a> etc.</p>
<h3 id="uefi-is-not-bios">UEFI is not BIOS</h3>
<p>The sometimes used term &ldquo;UEFI BIOS&rdquo; is incorrect (even my motherboard manufacturer ASUSTeK uses it),
because both UEFI and BIOS are subtypes of firmware - i.e. separate, different, standalone firmware
standards:</p>
<p><img src="uefi-is-not-bios.png" alt=""></p>
<p>Maybe because some people refer to UEFI BIOS, people use the term &ldquo;legacy BIOS&rdquo; to mean &ldquo;yes, I&rsquo;m really talking about the old IBM-era BIOS&rdquo;.</p>
<p>(Sidenote:
<a href="https://asahilinux.org/2021/03/progress-report-january-february-2021/#bridging-two-worlds">there exist also other firmware standards</a>, like DeviceTree)</p>
<h3 id="efi-system-partition">EFI system partition</h3>
<p>As a Windows user you might&rsquo;ve noticed that there is this mysterious &ldquo;system reserved&rdquo; partition:</p>
<p><img src="uefi-system-reserved-partition.png" alt=""></p>
<p>This is the <a href="https://en.wikipedia.org/wiki/EFI_system_partition">ESP (EFI System Partition)</a> - a partition
used for booting an EFI-compliant system.</p>
<p>The ESP is usually <a href="https://en.wikipedia.org/wiki/File_Allocation_Table#FAT32">FAT32</a>-formatted
partition with minimum 100 MB of space, some guidelines suggesting 512 MB.</p>
<p>The partition contains <a href="https://en.wikipedia.org/wiki/Unified_Extensible_Firmware_Interface#Applications">EFI applications</a>,
usually in own directories. There can be multiple EFI applications because you might have multiple
operating systems installed.
In my mental model I think of these directories as &ldquo;slots&rdquo; for each of my OSes.</p>
<p>You can quite easily create this partition from scratch with basic Linux built-in utilities
(<code>$ fdisk</code>, <code>$ mkfs.fat -F 32</code>) if you want. Just be sure to set partition type to EFI system!</p>
<p>Fortunately an ESP is not magic - it&rsquo;s just a partition with files and some file paths have
special meaning (default EFI app to boot if no boot selection indicated).</p>
<h3 id="efi-variables">EFI variables</h3>
<p>EFI specifies that there are variables stored inside your motherboard NVRAM. One of these variables is
the default boot entry (&ldquo;BootCurrent&rdquo;), which points to another variable (one of the boot entries) that
contains the path to the EFI application to boot.</p>
<p>The boot entry variable can also contain additional arguments for the EFI application.
One of these uses is Linux EFI stub (more on this below), where the variable contains Linux kernel
command line that has to specify which partition the root filesystem is in
(<a href="https://wiki.debian.org/EFIStub#Add_the_boot_entry">link</a>). GRUB doesn&rsquo;t need this, since that is
specified in a configuration file.</p>
<p>These variables can be modified from your OS, so you no longer have to &ldquo;boot into BIOS&rdquo; to change
boot order or add new boot entries etc.</p>
<h3 id="boot-process-with-efi">Boot process with EFI</h3>
<p><img src="uefi-process.png" alt=""></p>
<p>Motherboard&rsquo;s firmware is basically always in flash (so it can be upgraded). EFI var storage needs
flash anyway, because they&rsquo;re not very good &ldquo;variables&rdquo; if they cannot be changed. :)</p>
<h3 id="linux-efi-stub">Linux EFI stub</h3>
<p><a href="https://wiki.archlinux.org/index.php/EFISTUB">EFI stub</a> feature in Linux means that the kernel image
looks like an EFI application, so the kernel can be directly loaded without a separate bootloader -
skipping GRUB (the most popular bootloader for Linux).</p>
<p>Why use EFI stub? It might be because I don&rsquo;t know what I&rsquo;m doing, but I ended up with both: ..</p>
<ul>
<li>GRUB in my <code>/boot</code> (NOT the ESP) <strong>and</strong></li>
<li>GRUB in the ESP</li>
</ul>
<p>.. when I was testing some boot setup things in a VM.
I didn&rsquo;t know which one I should edit and where to debug when I couldn&rsquo;t get the dual-boot working
(turns out my hypervisor was not persisting EFI vars).</p>
<p>This was a catalyst for me to use EFI stub, because less software means less complexity.</p>
<p>Linux EFI stub is not perfect though. Since you need to give the kernel (the UEFI app) special arguments
(where the root partition is) for it to boot, these arguments need to be in the NVRAM. If the NVRAM
gets emptied or the NVRAM becomes faulty, the arguments get lost and you system is not bootable.
Usually UEFI implementations let you even navigate to an UEFI app from the ESP to boot, but that
alone doesn&rsquo;t work without the extra arguments. With &ldquo;argument-less&rdquo; EFI apps if your NVRAM becomes
faulty you can just navigate to the UEFI app to boot it.</p>
<h3 id="implications-of-efi-variables">Implications of EFI variables</h3>
<p>State is littered around the motherboard (EFI vars) and the drive (ESP).
Therefore you can&rsquo;t expect to throw your drive in a new motherboard and be 100 % sure it works, because
EFI vars can contain arguments for EFI apps (like Linux Kernel command line parameters if you&rsquo;re using EFI stub).
Although this &ldquo;Linux EFI stub&rdquo; might be a fringe use case and not ideal usage pattern
(perhaps EFI applications should be runnable without additional arguments.)</p>
<p>Naively I would&rsquo;ve preferred the EFI vars to live in the ESP but then again, a drive itself alone
semantically shouldn&rsquo;t be allowed to specify how the computer should boot..
Perhaps this was better than the added complexity of supporting EFI vars both in motherboard NVRAM <strong>and</strong> the ESP.</p>
<p>One frustrating thing about EFI variables is that their storage format is internal to the specific
EFI firmware, i.e. each motherboard can have different storage format for the variables.
This is not a problem in normal use (regular users don&rsquo;t need to know), but remember that virtual machines are
essentially software defined computers, and sometimes you would want to specify EFI variables (like
use Linux EFI stub to boot Linux) before booting a VM, but there is no generic way to modify the
variables except from inside the VM or some other EFI application already running inside the VM.
Granted, in this use case you can control the EFI firmware that&rsquo;ll be booting your VM, and thus you
know the internal storage format and can get/write tooling to manipulate the vars, but that&rsquo;s one more
thing to worry about. <a href="https://rwmj.wordpress.com/2015/03/25/edit-uefi-varstores/">Read more</a>.</p>
<h2 id="qemu-and-uefi">QEMU and UEFI</h2>
<p>QEMU is a generic and open source machine emulator and virtualizer. It allows you to run VMs.</p>
<h3 id="built-in-boot-modes">Built-in boot modes</h3>
<p>QEMU has built-in support:</p>
<ul>
<li>For legacy BIOS booting</li>
<li><a href="https://qemu.readthedocs.io/en/latest/system/linuxboot.html">Directly booting Linux</a>
<ul>
<li>By specifying paths (in your host!) to Linux kernel and
<a href="https://en.wikipedia.org/wiki/Initial_ramdisk">Initrd</a> with switches <code>-kernel</code> and <code>-initrd</code></li>
<li>You probably also have to define a Linux command line with <code>-append</code> (example: <code>-append &quot;root=/dev/sda1&quot; </code>)</li>
<li>This is great for testing, but a bit weird for &ldquo;normal VM usage&rdquo; because QEMU needs to first access
the kernel and initrd which are usually stored inside the VM&rsquo;s filesystem. You either need a
hack to temp-mount the VM&rsquo;s FS on the host to grab a copy the kernel and initrd or reverse
the traditional ownership model of VM managing the kernel+initrd and just embrace the model of
the host being in charge of VM&rsquo;s internals. I.e. you accept that if you update your OS inside
the VM and the kernel gets updated, you&rsquo;ll accidentally boot next into the old kernel unless you
remember to copy the in-VM copy of the kernel to host-side copy of the VM-kernel.</li>
</ul>
</li>
<li>UEFI boot
<ul>
<li>But only if you specify the UEFI firmware files - QEMU doesn&rsquo;t provide them (it does for legacy BIOS)</li>
<li>This means you have to download external UEFI firmware (usually a simple task of asking your package manager though)</li>
</ul>
</li>
</ul>
<h3 id="qemu-and-uefi-boot">QEMU and UEFI boot</h3>
<p>Like mentioned above, you have to provide the UEFI firmware. One popular choice for virtualized
hardware is OMVF (I guess it&rsquo;s a sub-project of EDK II) by TianoCore.</p>
<p>Summarized, you can UEFI boot VMs with switches:</p>
<pre><code>-drive if=pflash,format=raw,unit=0,readonly,file=OVMF_CODE-pure-efi.fd \
-drive if=pflash,format=raw,unit=1,file=OVMF_VARS-pure-efi.fd \
</code></pre>
<p>The first is the firmware, and the second is the EFI vars storage file (assuming you want your changes
to EFI vars to persist across VM reboots). The <code>pflash</code> stands for
<a href="https://wiki.qemu.org/Features/PC_System_Flash">platform-specific flash</a>.</p>
<p>Most popular distros have packages that you can get with your package manager, but I didn&rsquo;t seem to
have luck in finding my &ldquo;EFI vars&rdquo; file in the package I installed for Ubuntu. Remember, EFI vars storage
format is specific to firmware (in this case OMVF), even the version, and therefore I had to find my
OMVF (firmware, EFI vars file) combo from elsewhere.</p>
<h3 id="managing-boot-options-from-os">Managing boot options from OS</h3>
<p>Look into <a href="https://wiki.archlinux.org/index.php/EFISTUB#efibootmgr">efibootmgr</a> command.</p>
<p><a href="https://wiki.archlinux.org/index.php/Unified_Extensible_Firmware_Interface#UEFI_variables">efivar</a> command might also be of interest.</p>
<h3 id="finding-working-firmware-and-efi-vars-file">Finding working firmware and EFI vars file</h3>
<p>(WARNING: I might&rsquo;ve messed up because when later testing the OVMF files provided by apt-get they seemed to
work. But I&rsquo;ll leave this chapter in case it helps someone else struggling)</p>
<p>I found an
<a href="https://opensuse.pkgs.org/15.2/opensuse-update-oss-x86_64/qemu-ovmf-x86_64-201911-lp152.6.2.1.noarch.rpm.html">openSUSE package</a>
and I think I tried combo <code>(ovmf-x86_64.bin, ovmf-x86_64-vars.bin)</code> from there <strong>but did not get it working</strong>.</p>
<p>Eventually, many hours later, I found an RPM package
(<a href="https://www.kraxel.org/repos/jenkins/edk2/">directory listing</a>)
that had a working combo: <code>(OVMF_CODE-pure-efi.fd, OVMF_VARS-pure-efi.fd)</code>.</p>
<p>It is an RPM package, but I could extract the files with this command:</p>
<pre><code>$ rpm2cpio edk2.git-ovmf-x64-0-20201222.1544.g6c5801be6e.noarch.rpm | cpio -idmv
</code></pre>
<p>(<a href="https://stackoverflow.com/questions/18787375/how-do-i-extract-the-contents-of-an-rpm">Credit</a>)</p>
<p>Most of these UEFI firmware packages contain multiple variants with triplets of each <code>($.bin, $-code.bin, $-vars.bin)</code> combo, like:</p>
<p><img src="uefi-firmware-combos.png" alt=""></p>
<p>I don&rsquo;t know what the difference between the base and <code>-code</code> versions are in the triplet. They both
are somewhere around 2 MB so I guess they&rsquo;re both firmware (the EFI vars file is much smaller!), so
I tried the <code>-code</code> one and it worked for me..</p>
<p>There are abbreviations like <code>ms</code>, <code>4m</code>, <code>smm</code> etc. for each variant. I suspect variants are set up
with secure boot, some are not, some have different signing keys etc.
I&rsquo;m not using secure boot, but I just wanted to share if it helps. I went with the most bare, &ldquo;pure&rdquo;
variant because it sounded like it has secure boot disabled.</p>
<h3 id="troubleshooting">Troubleshooting</h3>
<p>I booted so many times into my Ubuntu VM to use <code>$ efibootmgr</code> to edit my boot options, and then shut down
the VM only to notice that the vars file was not changed (I compared <code>$ sha256sum</code> between reboots).
I didn&rsquo;t even know if QEMU would update the EFI vars file after shutting down the VM or immediately
when the var is modified.. Just goes to show that before you start with a working condition it&rsquo;s much
harder to try to operate on only safe assumptions.</p>
<p>This was before I found the correct working firmware-EFIvars combo from kraxel.org. I didn&rsquo;t get any
error messages - the EFI vars file was just not being updated. Somewhere along the stack (in QEMU or
OVMF) there was an error that prevented updating the EFI vars NVRAM and I was not given any error code,
just bold faced lie of silent success. Ugh. Computers..</p>
<p>What I wish I had tried earlier was to just boot into EFI shell because you can edit EFI vars much
faster there without booting and logging in to the OS (to top it off, I was having intermittent
<a href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1872863">graphical glitches</a> so I had to boot
many times to even reach the VM).</p>
<p><a href="https://wiki.archlinux.org/index.php/Unified_Extensible_Firmware_Interface#Important_UEFI_Shell_commands">Read more about UEFI shell &amp; important commands</a>.</p>
<h2 id="why-is-everything-so-hard">Why is everything so hard?</h2>
<p>I&rsquo;m left highly annoyed, once again thinking &ldquo;computers were a mistake&rdquo;. Why are these things so
poorly documented and so hard.. Prepare your body for a rant.</p>
<h3 id="my-troubles-with-uefi">My troubles with UEFI</h3>
<ul>
<li>
<p>Had to learn the hard way that UEFI firmware and UEFI vars file are deeply dependent on each other
&amp; maybe even exact versions</p>
</li>
<li>
<p>When I did something wrong and I &ldquo;successfully&rdquo; changed boot options (EFI vars), I was being
lied to and the changes just didn&rsquo;t persist after reboot without any explanation to me. If you write
important code that ignores the error case, you should have your developer rights taken away.</p>
</li>
<li>
<p>UEFI&rsquo;s built-in strategy seems to try booting each boot item in order and treating each error equally
with &ldquo;it didn&rsquo;t work so I guess it wasn&rsquo;t supposed to work so let&rsquo;s not show any error messages
and continue to next item&rdquo;. This means that when you try to boot something exact, it goes in totally other
direction without explanation and you&rsquo;re left wondering what just happened.</p>
<ul>
<li>I understand having boot options like removable drives before your OS and their errors being
expected in nature and thus not showing error messages, but I think there should&rsquo;ve been a
distinction between expected and unexpected errors - the latter of which should&rsquo;ve been shown to
user, preferably with option of managing the boot options if there accidentally is a non-booting
unexpected error before the actual bootable OS option.</li>
</ul>
</li>
</ul>
<h3 id="my-troubles-with-bootloaders">My troubles with bootloaders</h3>
<p>Bootloaders seem to be notoriously bad at explaining what went wrong, often hiding error messages
and GRUB just throwing you into a prompt expecting you&rsquo;re a bootloader developer.
Think of how often that expectation is true and how often there&rsquo;s a helpless user with a desire to
be helped in understanding what went wrong and how to disaster-recovery boot into the OS? A bootloader
has only one job..</p>
<p>Here&rsquo;s a screen you get when you&rsquo;re stuck with non-booting GRUB installation:</p>
<p><img src="uefi-bootloader-misery-grub.png" alt=""></p>
<p>Does the above answer:</p>
<ul>
<li>What was the error that ended up getting us here?
<ul>
<li>It clearly must&rsquo;ve been an error because what % of installations actually expect to boot into GRUB?</li>
</ul>
</li>
<li>What you should do next to boot into Linux?</li>
</ul>
<p>Here&rsquo;s how to boot from this situation:</p>
<p><img src="uefi-bootloader-misery-grub-no-instructions.png" alt=""></p>
<p>Does somebody expect me to remember those magic spells?</p>
<p>Moving on to roast rEFInd.. It has a curious feature where when you specify a <code>volume</code> it can&rsquo;t find
(or access), it just silently continues and the next error you get is just a symptom of the volume
not being found but you&rsquo;re essentially getting <strong>an unrelated error message</strong>.</p>
<p>I tested by specifying <code>volume notGoingToFindThis</code>. Here&rsquo;s what I got:</p>
<p><img src="uefi-bootloader-misery-refind.png" alt=""></p>
<p>This error message (&ldquo;not found while loading vmlinuz&rdquo;) is proudly ambiguous enough to maybe mean:</p>
<ul>
<li>The kernel was not found</li>
<li>The kernel was found but the kernel reported &ldquo;not found&rdquo; while trying to boot? Was initrd.img missing?</li>
</ul>
<p>Would <code>not found: /boot/vmlinuz</code> have been too helpful? But I digress.. the error message actually
had a third meaning: the partition I specified was not found (so of course none of the files will be found).</p>
<p>I don&rsquo;t even want to think how many hours I lost because of this. My actual problem was more nuanced
(not just a stupid typo) and might&rsquo;ve been because my VM specified a partition-less disk (which Linux
supports), which I guess rEFInd doesn&rsquo;t support so my volume was not being found even though I had
the correct label. That&rsquo;s totally reasonable, but give me the right error message instead of sending
me on a goose chase!</p>

    </div>
	<div class="post-footer">
		<hr />

		<img src="/signature.png" alt="signature" style="height: 55px;" />

		<p>Thanks for reading! <span style="font-style: normal;">üòç</span></p>
		<p>
			If you like my writing, consider following me on
			<a href="https://twitter.com/joonas_fi">Twitter</a>.
		</p>

		<p>
			Stay updated on my blog posts &amp; projects - sign up for
			<a href="https://buttondown.email/joonas">my newsletter</a>. üöÄ
			<br />
			<small>
				No spam, unsubscribe any time.
				<a href="/feed.xml">RSS</a> also available.
			</small>
		</p>
	</div>
  </article>

  <hr />

  
<div id="disqus_thread"></div>
<script type="text/javascript">

var disqus_identifier = '\/2021\/02\/uefi-pc-boot-process-and-uefi-with-qemu';

(function() {
   if (window.location.hostname.indexOf('.dev.fn61.net') != -1) {
        document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
        return;
    }

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'joonas-fi';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  
  

  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/today-i-learned/">Today I Learned</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/contact/">Contact</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#legacy-bios">Legacy BIOS</a>
      <ul>
        <li><a href="#bios-as-a-standard">BIOS as a standard</a></li>
        <li><a href="#bios-as-the-implementation">BIOS as the implementation</a></li>
        <li><a href="#how-a-bios-works">How a BIOS works</a></li>
        <li><a href="#limitations-of-legacy-bios">Limitations of legacy BIOS</a></li>
        <li><a href="#legacy-bios-boot-process">Legacy BIOS boot process</a></li>
      </ul>
    </li>
    <li><a href="#modern-times-uefi">Modern times: UEFI</a>
      <ul>
        <li><a href="#why-do-we-need-uefi">Why do we need UEFI?</a></li>
        <li><a href="#uefi-is-not-bios">UEFI is not BIOS</a></li>
        <li><a href="#efi-system-partition">EFI system partition</a></li>
        <li><a href="#efi-variables">EFI variables</a></li>
        <li><a href="#boot-process-with-efi">Boot process with EFI</a></li>
        <li><a href="#linux-efi-stub">Linux EFI stub</a></li>
        <li><a href="#implications-of-efi-variables">Implications of EFI variables</a></li>
      </ul>
    </li>
    <li><a href="#qemu-and-uefi">QEMU and UEFI</a>
      <ul>
        <li><a href="#built-in-boot-modes">Built-in boot modes</a></li>
        <li><a href="#qemu-and-uefi-boot">QEMU and UEFI boot</a></li>
        <li><a href="#managing-boot-options-from-os">Managing boot options from OS</a></li>
        <li><a href="#finding-working-firmware-and-efi-vars-file">Finding working firmware and EFI vars file</a></li>
        <li><a href="#troubleshooting">Troubleshooting</a></li>
      </ul>
    </li>
    <li><a href="#why-is-everything-so-hard">Why is everything so hard?</a>
      <ul>
        <li><a href="#my-troubles-with-uefi">My troubles with UEFI</a></li>
        <li><a href="#my-troubles-with-bootloaders">My troubles with bootloaders</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f&text=UEFI%2c%20PC%20boot%20process%20and%20UEFI%20with%20QEMU">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f&title=UEFI%2c%20PC%20boot%20process%20and%20UEFI%20with%20QEMU">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f&is_video=false&description=UEFI%2c%20PC%20boot%20process%20and%20UEFI%20with%20QEMU">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=UEFI%2c%20PC%20boot%20process%20and%20UEFI%20with%20QEMU&body=Check out this article: https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f&title=UEFI%2c%20PC%20boot%20process%20and%20UEFI%20with%20QEMU">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f&title=UEFI%2c%20PC%20boot%20process%20and%20UEFI%20with%20QEMU">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f&title=UEFI%2c%20PC%20boot%20process%20and%20UEFI%20with%20QEMU">
      <i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f&title=UEFI%2c%20PC%20boot%20process%20and%20UEFI%20with%20QEMU">
      <i class="fab fa-digg fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f&name=UEFI%2c%20PC%20boot%20process%20and%20UEFI%20with%20QEMU&description=Recently%20I%20learned%20a%20lot%20more%20about%20UEFI%2fBIOS%20than%20I%20would%26rsquo%3bve%20liked%20to%2c%20when%20I%20was%20configuring%20my%20new%20exotic%20system%26rsquo%3bs%20boot%20process.%20It%20just%20goes%20to%20show%20you%20that%20when%20you%20step%20away%20from%20the%20well-traveled%20path%2c%20you%26rsquo%3bre%20going%20to%20run%20into%20stupid%20problems%20and%20have%20to%20understand%20deeper%20about%20how%20things%20work.%20So%20I%26rsquo%3bm%20sharing%20what%20I%20learned.%0aLegacy%20BIOS%20To%20better%20understand%20UEFI%2c%20we%20must%20first%20dig%20into%20a%20little%20bit%20of%20history.">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fjoonas.fi%2f2021%2f02%2fuefi-pc-boot-process-and-uefi-with-qemu%2f&t=UEFI%2c%20PC%20boot%20process%20and%20UEFI%20with%20QEMU">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2023  joonas.fi 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/today-i-learned/">Today I Learned</a></li>
         
        <li><a href="/about/">About</a></li>
         
        <li><a href="/contact/">Contact</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>



</html>
