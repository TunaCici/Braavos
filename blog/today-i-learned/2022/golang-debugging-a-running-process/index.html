<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Golang: debugging a running process | joonas.fi</title>
  <meta name="description" content="Let’s get to work ᕕ( ᐛ )ᕗ">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Golang: debugging a running process" />
<meta property="og:description" content="About the problem in general Usually one can debug by changing your program code.
This can be called instrumentation: adding debug instrumentation to aid in learning about the bug, and then running the problematic action again.
The instrumentation can either be &ldquo;print statements&rdquo; or something more elegant like adding debugger breakpoints, or even building your code unchanged but asking the compiler to add debug symbols.
But sometimes the problem you&rsquo;re encountering might happen so rarely that you can&rsquo;t rebuild (and thus re-run) the binary, but instead you&rsquo;re left with debugging a running process." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://joonas.fi/today-i-learned/2022/golang-debugging-a-running-process/" /><meta property="article:section" content="today-i-learned" />
<meta property="article:published_time" content="2022-02-26T09:45:00+00:00" />
<meta property="article:modified_time" content="2022-02-26T09:45:00+00:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Golang: debugging a running process"/>
<meta name="twitter:description" content="About the problem in general Usually one can debug by changing your program code.
This can be called instrumentation: adding debug instrumentation to aid in learning about the bug, and then running the problematic action again.
The instrumentation can either be &ldquo;print statements&rdquo; or something more elegant like adding debugger breakpoints, or even building your code unchanged but asking the compiler to add debug symbols.
But sometimes the problem you&rsquo;re encountering might happen so rarely that you can&rsquo;t rebuild (and thus re-run) the binary, but instead you&rsquo;re left with debugging a running process."/>

  
  
  
  <link rel="stylesheet" href="/css/style-white.css">
  
   <link rel="stylesheet" href="/css/custom.css"> 
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  <link rel="icon" type="image/png" href="/favicon.ico" />
  
  
  
  
  
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-24122659-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/today-i-learned/">Today I Learned</a></li>
         
        <li><a href="/about/">About</a></li>
         
        <li><a href="/contact/">Contact</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://joonas.fi/complaint-corner/2022/paypal-click-does-nothing/">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://joonas.fi/complaint-corner/2022/google-doesnt-tell-which-requirement-i-dont-pass/">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fjoonas.fi%2ftoday-i-learned%2f2022%2fgolang-debugging-a-running-process%2f">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fjoonas.fi%2ftoday-i-learned%2f2022%2fgolang-debugging-a-running-process%2f&text=Golang%3a%20debugging%20a%20running%20process">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fjoonas.fi%2ftoday-i-learned%2f2022%2fgolang-debugging-a-running-process%2f&title=Golang%3a%20debugging%20a%20running%20process">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fjoonas.fi%2ftoday-i-learned%2f2022%2fgolang-debugging-a-running-process%2f&is_video=false&description=Golang%3a%20debugging%20a%20running%20process">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Golang%3a%20debugging%20a%20running%20process&body=Check out this article: https%3a%2f%2fjoonas.fi%2ftoday-i-learned%2f2022%2fgolang-debugging-a-running-process%2f">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fjoonas.fi%2ftoday-i-learned%2f2022%2fgolang-debugging-a-running-process%2f&title=Golang%3a%20debugging%20a%20running%20process">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fjoonas.fi%2ftoday-i-learned%2f2022%2fgolang-debugging-a-running-process%2f&title=Golang%3a%20debugging%20a%20running%20process">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fjoonas.fi%2ftoday-i-learned%2f2022%2fgolang-debugging-a-running-process%2f&title=Golang%3a%20debugging%20a%20running%20process">
      <i class="fab fa-stumbleupon " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=https%3a%2f%2fjoonas.fi%2ftoday-i-learned%2f2022%2fgolang-debugging-a-running-process%2f&title=Golang%3a%20debugging%20a%20running%20process">
      <i class="fab fa-digg " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fjoonas.fi%2ftoday-i-learned%2f2022%2fgolang-debugging-a-running-process%2f&name=Golang%3a%20debugging%20a%20running%20process&description=About%20the%20problem%20in%20general%20Usually%20one%20can%20debug%20by%20changing%20your%20program%20code.%0aThis%20can%20be%20called%20instrumentation%3a%20adding%20debug%20instrumentation%20to%20aid%20in%20learning%20about%20the%20bug%2c%20and%20then%20running%20the%20problematic%20action%20again.%0aThe%20instrumentation%20can%20either%20be%20%26ldquo%3bprint%20statements%26rdquo%3b%20or%20something%20more%20elegant%20like%20adding%20debugger%20breakpoints%2c%20or%20even%20building%20your%20code%20unchanged%20but%20asking%20the%20compiler%20to%20add%20debug%20symbols.%0aBut%20sometimes%20the%20problem%20you%26rsquo%3bre%20encountering%20might%20happen%20so%20rarely%20that%20you%20can%26rsquo%3bt%20rebuild%20%28and%20thus%20re-run%29%20the%20binary%2c%20but%20instead%20you%26rsquo%3bre%20left%20with%20debugging%20a%20running%20process.">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fjoonas.fi%2ftoday-i-learned%2f2022%2fgolang-debugging-a-running-process%2f&t=Golang%3a%20debugging%20a%20running%20process">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#about-the-problem-in-general">About the problem in general</a></li>
    <li><a href="#option-1-attach-a-debugger-to-a-running-program">Option 1: attach a debugger to a running program</a></li>
    <li><a href="#option-2-quit-with-a-stack-trace-when-you-can-see-the-processs-stderr">Option 2: quit with a stack trace, when you can see the process&rsquo;s stderr</a></li>
    <li><a href="#option-3-quit-with-a-stack-trace-when-you-cant-see-the-processs-stderr">Option 3: quit with a stack trace, when you can&rsquo;t see the process&rsquo;s stderr</a></li>
  </ul>
</nav>
    </div>
  </span>
</div>

<div class="alert-warning">
	🚨
	<a href="https://www.reuters.com/world/europe/icc-says-may-investigate-possible-war-crimes-after-russian-invasion-ukraine-2022-02-25/">Putin is a war criminal</a>.
	<a href="https://arstechnica.com/science/2022/03/russia-attacked-ukrainian-hospitals-violating-humanitarian-law-who-says/">Russians are bombing hospitals</a>.
	💔🇺🇦
</div>



  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        Golang: debugging a running process
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2022-02-26 09:45:00 &#43;0000 UTC" itemprop="datePublished">2022-02-26</time>
          
        </div>
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/tags/golang/" rel="tag">golang</a>
            
        </div>
        
      </div>
    </header>

  
    <div class="content" itemprop="articleBody">
      <h2 id="about-the-problem-in-general">About the problem in general</h2>
<p>Usually one can debug by changing your program code.</p>
<p>This can be called <em>instrumentation</em>: adding <em>debug instrumentation</em> to aid in learning about the bug,
and then running the problematic action again.</p>
<p>The instrumentation can either be &ldquo;print statements&rdquo; or something more elegant like adding debugger
breakpoints, or even building your code unchanged but
<a href="https://gcc.gnu.org/onlinedocs/gcc/Debugging-Options.html">asking the compiler to add debug symbols</a>.</p>
<p>But sometimes the problem you&rsquo;re encountering might happen so rarely that you can&rsquo;t rebuild
(and thus re-run) the binary, but instead you&rsquo;re left with debugging a running process.
This post is about that case, with Go.</p>
<h2 id="option-1-attach-a-debugger-to-a-running-program">Option 1: attach a debugger to a running program</h2>
<p>You can use a debugger, such as <a href="https://github.com/go-delve/delve">Delve</a> to attach to an existing
process. No recompilation or instrumentation adding needed.</p>
<p>Assuming the PID of our process is <code>4040133</code>:</p>
<pre tabindex="0"><code>$ sudo ./dlv attach 4040133
Type &#39;help&#39; for list of commands.
(dlv) goroutines
... goroutines&#39; state is dumped here ...
</code></pre><p>That was easy! Delve is of course much more powerful: you can set breakpoints, watch variables,
step through code, etc.</p>
<h2 id="option-2-quit-with-a-stack-trace-when-you-can-see-the-processs-stderr">Option 2: quit with a stack trace, when you can see the process&rsquo;s stderr</h2>
<p>Go offers this nice feature out of the box: when you send it
<a href="https://pkg.go.dev/os/signal#hdr-Default_behavior_of_signals_in_Go_programs">SIGQUIT signal</a>, it
exits with a stack dump.
The stack dump is shown for all goroutines, so you can know what each &ldquo;thread&rdquo; was doing at the time
of receiving <code>SIGQUIT</code>.</p>
<p>So in practice, this stack trace is really valuable to you. Now let&rsquo;s learn to dig it out.</p>
<p>You can get that dump written to the process&rsquo;s stderr by running (still assuming our PID is <code>4040133</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">$</span> <span style="color:#5918bb;font-weight:bold">kill</span> -QUIT <span style="color:#5918bb;font-weight:bold">4040133</span>
</span></span></code></pre></div><p>In the other terminal where you&rsquo;re running your program (or where it writes its stderr, maybe
<code>$ journalctl</code> if your app is running under systemd) you&rsquo;ll see:</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#aaa">SIGQUIT: quit
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">PC=0x464ce1 m=0 sigcode=0
</span></span></span><span style="display:flex;"><span><span style="color:#aaa"></span><span style="color:#fff;background-color:#c00">
</span></span></span><span style="display:flex;"><span><span style="color:#fff;background-color:#c00"></span><span style="color:#aaa">goroutine 0 [idle]:
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">runtime.futex()
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/usr/local/go/src/runtime/sys_linux_amd64.s:552 +0x21
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">runtime.futexsleep(0x7fff3a356560?, 0x441df3?, 0xc000032000?)
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/usr/local/go/src/runtime/os_linux.go:56 +0x36
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">runtime.notesleep(0xbf91d0)
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/usr/local/go/src/runtime/lock_futex.go:159 +0x87
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">runtime.mPark()
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/usr/local/go/src/runtime/proc.go:1447 +0x2a
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">runtime.stoplockedm()
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/usr/local/go/src/runtime/proc.go:2611 +0x65
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">runtime.schedule()
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/usr/local/go/src/runtime/proc.go:3308 +0x3d
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">runtime.park_m(0xc0001251e0?)
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/usr/local/go/src/runtime/proc.go:3525 +0x14d
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">runtime.mcall()
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/usr/local/go/src/runtime/asm_amd64.s:425 +0x43
</span></span></span><span style="display:flex;"><span><span style="color:#aaa"></span><span style="color:#fff;background-color:#c00">
</span></span></span><span style="display:flex;"><span><span style="color:#fff;background-color:#c00"></span><span style="color:#aaa">goroutine 1 [chan receive, 21508 minutes]:
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">github.com/function61/gokit/sync/taskrunner.(*Runner).Wait(...)
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/go/pkg/mod/github.com/function61/gokit@v0.0.0-20211228101508-315ec8b830c9/sync/taskrunner/taskrunner.go:79
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">github.com/joonas-fi/joonas-sys/pkg/statusbar.logic({0x96f6f8, 0xc000030cc0})
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/workspace/pkg/statusbar/bar.go:150 +0x1bf
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">github.com/joonas-fi/joonas-sys/pkg/statusbar.Entrypoint.func1(0xc0001bc780?, {0xc28ab8?, 0x0?, 0x0?})
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/workspace/pkg/statusbar/bar.go:34 +0x25
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">github.com/spf13/cobra.(*Command).execute(0xc0001bc780, {0xc28ab8, 0x0, 0x0})
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/go/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:860 +0x663
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">github.com/spf13/cobra.(*Command).ExecuteC(0xc000187b80)
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/go/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:974 +0x3b4
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">github.com/spf13/cobra.(*Command).Execute(...)
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/go/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:902
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">main.main()
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/workspace/cmd/jsys/main.go:42 +0x434
</span></span></span><span style="display:flex;"><span><span style="color:#aaa"></span><span style="color:#fff;background-color:#c00">
</span></span></span><span style="display:flex;"><span><span style="color:#fff;background-color:#c00"></span><span style="color:#aaa">goroutine 17 [syscall, 21508 minutes]:
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">os/signal.signal_recv()
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/usr/local/go/src/runtime/sigqueue.go:168 +0x98
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">os/signal.loop()
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/usr/local/go/src/os/signal/signal_unix.go:23 +0x19
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">created by os/signal.Notify.func1.1
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/usr/local/go/src/os/signal/signal.go:151 +0x2a
</span></span></span><span style="display:flex;"><span><span style="color:#aaa"></span><span style="color:#fff;background-color:#c00">
</span></span></span><span style="display:flex;"><span><span style="color:#fff;background-color:#c00"></span><span style="color:#aaa">goroutine 18 [chan receive, 21508 minutes]:
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">github.com/function61/gokit/os/osutil.CancelOnInterruptOrTerminate.func1()
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/go/pkg/mod/github.com/function61/gokit@v0.0.0-20211228101508-315ec8b830c9/os/osutil/canceloninterruptorterminate.go:32 +0x4d
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">created by github.com/function61/gokit/os/osutil.CancelOnInterruptOrTerminate
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/go/pkg/mod/github.com/function61/gokit@v0.0.0-20211228101508-315ec8b830c9/os/osutil/canceloninterruptorterminate.go:31 +0x10a
</span></span></span><span style="display:flex;"><span><span style="color:#aaa"></span><span style="color:#fff;background-color:#c00">
</span></span></span><span style="display:flex;"><span><span style="color:#fff;background-color:#c00"></span><span style="color:#aaa">goroutine 19 [syscall, 4080 minutes]:
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">syscall.Syscall(0x0, 0x0, 0xc0000ea3e4, 0xc1c)
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/usr/local/go/src/syscall/asm_linux_amd64.s:20 +0x5
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">syscall.read(0xc000072060?, {0xc0000ea3e4?, 0x9?, 0xc0002e2ea0?})
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/usr/local/go/src/syscall/zsyscall_linux_amd64.go:696 +0x4d
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">syscall.Read(...)
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/usr/local/go/src/syscall/syscall_unix.go:188
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">internal/poll.ignoringEINTRIO(...)
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/usr/local/go/src/internal/poll/fd_unix.go:794
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">internal/poll.(*FD).Read(0xc000072060?, {0xc0000ea3e4?, 0xc1c?, 0xc1c?})
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/usr/local/go/src/internal/poll/fd_unix.go:163 +0x285
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">os.(*File).read(...)
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/usr/local/go/src/os/file_posix.go:31
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">os.(*File).Read(0xc00000e010, {0xc0000ea3e4?, 0x1?, 0x120?})
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/usr/local/go/src/os/file.go:119 +0x5e
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">bufio.(*Scanner).Scan(0xc0000e3ef8)
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/usr/local/go/src/bufio/scan.go:215 +0x865
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">github.com/joonas-fi/joonas-sys/pkg/statusbar.logic.func1({0x0?, 0x0?})
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/workspace/pkg/statusbar/bar.go:61 +0x89
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">github.com/function61/gokit/sync/taskrunner.(*Runner).Start.func1()
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/go/pkg/mod/github.com/function61/gokit@v0.0.0-20211228101508-315ec8b830c9/sync/taskrunner/taskrunner.go:51 +0x45
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">created by github.com/function61/gokit/sync/taskrunner.(*Runner).Start
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/go/pkg/mod/github.com/function61/gokit@v0.0.0-20211228101508-315ec8b830c9/sync/taskrunner/taskrunner.go:50 +0x105
</span></span></span><span style="display:flex;"><span><span style="color:#aaa"></span><span style="color:#fff;background-color:#c00">
</span></span></span><span style="display:flex;"><span><span style="color:#fff;background-color:#c00"></span><span style="color:#aaa">goroutine 23 [chan receive, 1390 minutes]:
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">github.com/function61/gokit/sync/taskrunner.(*Runner).waitInternal.func2(...)
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/go/pkg/mod/github.com/function61/gokit@v0.0.0-20211228101508-315ec8b830c9/sync/taskrunner/taskrunner.go:101
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">github.com/function61/gokit/sync/taskrunner.(*Runner).waitInternal(0xc0000b2140)
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/go/pkg/mod/github.com/function61/gokit@v0.0.0-20211228101508-315ec8b830c9/sync/taskrunner/taskrunner.go:134 +0x30a
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">github.com/function61/gokit/sync/taskrunner.(*Runner).Done.func1.1()
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/go/pkg/mod/github.com/function61/gokit@v0.0.0-20211228101508-315ec8b830c9/sync/taskrunner/taskrunner.go:63 +0x25
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">created by github.com/function61/gokit/sync/taskrunner.(*Runner).Done.func1
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/go/pkg/mod/github.com/function61/gokit@v0.0.0-20211228101508-315ec8b830c9/sync/taskrunner/taskrunner.go:62 +0x5a
</span></span></span><span style="display:flex;"><span><span style="color:#aaa"></span><span style="color:#fff;background-color:#c00">
</span></span></span><span style="display:flex;"><span><span style="color:#fff;background-color:#c00"></span><span style="color:#aaa">goroutine 34 [chan send, 1390 minutes]:
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">github.com/vishvananda/netlink.routeSubscribeAt.func2()
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/go/pkg/mod/github.com/vishvananda/netlink@v1.1.0/route_linux.go:1075 +0x453
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">created by github.com/vishvananda/netlink.routeSubscribeAt
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">	/go/pkg/mod/github.com/vishvananda/netlink@v1.1.0/route_linux.go:1037 +0x2f2
</span></span></span><span style="display:flex;"><span><span style="color:#aaa"></span><span style="color:#fff;background-color:#c00">
</span></span></span><span style="display:flex;"><span><span style="color:#fff;background-color:#c00"></span><span style="color:#aaa">rax    0xca
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">rbx    0x0
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">rcx    0x464ce3
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">rdx    0x0
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">rdi    0xbf91d0
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">rsi    0x80
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">rbp    0x7fff3a356530
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">rsp    0x7fff3a3564e8
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">r8     0x0
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">r9     0x0
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">r10    0x0
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">r11    0x286
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">r12    0x43c400
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">r13    0x0
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">r14    0xbf8940
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">r15    0x7fb0d47ba96c
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">rip    0x464ce1
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">rflags 0x286
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">cs     0x33
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">fs     0x0
</span></span></span><span style="display:flex;"><span><span style="color:#aaa">gs     0x0
</span></span></span></code></pre></div><p>One under-appreciated thing about the dump is that it shows how long the syscalls have been waiting
for events! I knew my process&rsquo; problems started roughly 23h 15m ago, and the <code>1390 minutes</code>
correspond pretty much exactly with that!</p>
<p>With the above stack dump I was able to figure out where the bug was.</p>
<h2 id="option-3-quit-with-a-stack-trace-when-you-cant-see-the-processs-stderr">Option 3: quit with a stack trace, when you can&rsquo;t see the process&rsquo;s stderr</h2>
<p>If you&rsquo;re unsure where the process&rsquo; <code>stderr</code> goes, I would suggest first finding if there&rsquo;s an easy
solution for that. Let&rsquo;s say your process ID is <code>4040133</code>. Look up file descriptor #2
(<a href="https://man7.org/linux/man-pages/man3/stdout.3.html#DESCRIPTION">it&rsquo;s always stderr</a>) to know where
the <code>stderr</code> is connected:</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">$</span> ls -al /proc/4040133/fd/2
</span></span><span style="display:flex;"><span><span style="color:#aaa">l-wx------ 1 joonas joonas 64 Feb 20 19:37 /proc/4040133/fd/2 -&gt; /home/joonas/.xsession-errors
</span></span></span></code></pre></div><p>In my case my program was run under X.org server and the <code>stderr</code> simply was written to my
<code>.xsession-errors</code> file. I could&rsquo;ve saved trouble if I had realized that earlier.</p>
<p>Since at the time I wasn&rsquo;t sure where the <code>stderr</code> was being written to, I went with the nuclear option.</p>
<p>(This works even in cases where you assumed <code>stderr</code> was not valuable and you redirected it to <code>/dev/null</code>!!!)</p>
<p>The trick is to <code>$ strace</code> to your existing process and capture the <code>write(2, ...)</code> syscalls.
The first argument to <code>write()</code> syscall is the <em>file descriptor number</em>, where <code>2</code> again means <code>stderr</code>.</p>
<p>So attach to the process with <code>strace</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">$</span> sudo strace -p <span style="color:#5918bb;font-weight:bold">2143770</span> -s <span style="color:#5918bb;font-weight:bold">512</span> -ewrite 2&gt; /tmp/strace.log
</span></span></code></pre></div><p>Then in another terminal, ask your process to exit (this will trigger Go runtime to write the stack
trace, which would normally end discarded, by proxy of writing to <code>/dev/null</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#2c5dcd;font-weight:bold">$</span> <span style="color:#5918bb;font-weight:bold">kill</span> -QUIT <span style="color:#5918bb;font-weight:bold">2143770</span>
</span></span></code></pre></div><p>The process now dumps the stack trace to <code>/dev/null</code>, but it must do so by issuing syscalls, which
<code>strace</code> logs for you.</p>
<p>When you review the log file <code>/tmp/strace.log</code>, it looks like:</p>
<pre tabindex="0"><code>strace: Process 4040133 attached
--- SIGQUIT {si_signo=SIGQUIT, si_code=SI_USER, si_pid=2140770, si_uid=1000} ---
write(2, &#34;SIGQUIT: quit&#34;, 13)           = 13
write(2, &#34;\n&#34;, 1)                       = 1
write(2, &#34;PC=&#34;, 3)                      = 3
write(2, &#34;0x464ce1&#34;, 8)                 = 8
write(2, &#34; m=&#34;, 3)                      = 3
write(2, &#34;0&#34;, 1)                        = 1
write(2, &#34; sigcode=&#34;, 9)                = 9
write(2, &#34;0&#34;, 1)                        = 1
write(2, &#34;\n&#34;, 1)                       = 1
write(2, &#34;\n&#34;, 1)                       = 1
write(2, &#34;goroutine &#34;, 10)              = 10
write(2, &#34;0&#34;, 1)                        = 1
write(2, &#34; [&#34;, 2)                       = 2
write(2, &#34;idle&#34;, 4)                     = 4
write(2, &#34;]:\n&#34;, 3)                     = 3
write(2, &#34;runtime.futex&#34;, 13)           = 13
write(2, &#34;(&#34;, 1)                        = 1
write(2, &#34;)\n&#34;, 2)                      = 2
write(2, &#34;\t&#34;, 1)                       = 1
write(2, &#34;/usr/local/go/src/runtime/sys_linux_amd64.s&#34;, 43) = 43
write(2, &#34;:&#34;, 1)                        = 1
write(2, &#34;552&#34;, 3)                      = 3
write(2, &#34; +&#34;, 2)                       = 2
write(2, &#34;0x21&#34;, 4)                     = 4
write(2, &#34;\n&#34;, 1)                       = 1
write(2, &#34;runtime.futexsleep&#34;, 18)      = 18
write(2, &#34;(&#34;, 1)                        = 1
write(2, &#34;0x7ffc12443b70&#34;, 14)          = 14
write(2, &#34;?&#34;, 1)                        = 1
write(2, &#34;, &#34;, 2)                       = 2
write(2, &#34;0x441df3&#34;, 8)                 = 8
write(2, &#34;?&#34;, 1)                        = 1
write(2, &#34;, &#34;, 2)                       = 2
write(2, &#34;0xc000036500&#34;, 12)            = 12
write(2, &#34;?&#34;, 1)                        = 1
write(2, &#34;)\n&#34;, 2)                      = 2
write(2, &#34;\t&#34;, 1)                       = 1
write(2, &#34;/usr/local/go/src/runtime/os_linux.go&#34;, 37) = 37
write(2, &#34;:&#34;, 1)                        = 1
write(2, &#34;56&#34;, 2)                       = 2
write(2, &#34; +&#34;, 2)                       = 2
write(2, &#34;0x36&#34;, 4)                     = 4
write(2, &#34;\n&#34;, 1)                       = 1
write(2, &#34;runtime.notesleep&#34;, 17)       = 17
write(2, &#34;(&#34;, 1)                        = 1
write(2, &#34;0xbfd370&#34;, 8)                 = 8
write(2, &#34;)\n&#34;, 2)                      = 2
write(2, &#34;\t&#34;, 1)                       = 1
... output snipped ...
write(2, &#34;0xbfcae0&#34;, 8)                 = 8
write(2, &#34;\n&#34;, 1)                       = 1
write(2, &#34;r15    &#34;, 7)                  = 7
write(2, &#34;0x7ff9ba37ce03&#34;, 14)          = 14
write(2, &#34;\n&#34;, 1)                       = 1
write(2, &#34;rip    &#34;, 7)                  = 7
write(2, &#34;0x464ce1&#34;, 8)                 = 8
write(2, &#34;\n&#34;, 1)                       = 1
write(2, &#34;rflags &#34;, 7)                  = 7
write(2, &#34;0x286&#34;, 5)                    = 5
write(2, &#34;\n&#34;, 1)                       = 1
write(2, &#34;cs     &#34;, 7)                  = 7
write(2, &#34;0x33&#34;, 4)                     = 4
write(2, &#34;\n&#34;, 1)                       = 1
write(2, &#34;fs     &#34;, 7)                  = 7
write(2, &#34;0x0&#34;, 3)                      = 3
write(2, &#34;\n&#34;, 1)                       = 1
write(2, &#34;gs     &#34;, 7)                  = 7
write(2, &#34;0x0&#34;, 3)                      = 3
write(2, &#34;\n&#34;, 1)                       = 1
+++ exited with 2 +++
</code></pre><p>These are raw syscalls, so you need a bit of text processing to turn that back into human-readable
content.</p>
<p><a href="https://gist.github.com/psobot/6814658">A script like this may help you.</a></p>
<p>But the basic idea is this, let&rsquo;s take the first a few lines:</p>
<pre tabindex="0"><code>write(2, &#34;SIGQUIT: quit&#34;, 13)           = 13
write(2, &#34;\n&#34;, 1)                       = 1
write(2, &#34;PC=&#34;, 3)                      = 3
write(2, &#34;0x464ce1&#34;, 8)                 = 8
write(2, &#34; m=&#34;, 3)                      = 3
write(2, &#34;0&#34;, 1)                        = 1
write(2, &#34; sigcode=&#34;, 9)                = 9
write(2, &#34;0&#34;, 1)                        = 1
write(2, &#34;\n&#34;, 1)                       = 1
write(2, &#34;\n&#34;, 1)                       = 1
write(2, &#34;goroutine &#34;, 10)              = 10
write(2, &#34;0&#34;, 1)                        = 1
write(2, &#34; [&#34;, 2)                       = 2
write(2, &#34;idle&#34;, 4)                     = 4
write(2, &#34;]:\n&#34;, 3)                     = 3
write(2, &#34;runtime.futex&#34;, 13)           = 13
write(2, &#34;(&#34;, 1)                        = 1
write(2, &#34;)\n&#34;, 2)                      = 2
write(2, &#34;\t&#34;, 1)                       = 1
write(2, &#34;/usr/local/go/src/runtime/sys_linux_amd64.s&#34;, 43) = 43
write(2, &#34;:&#34;, 1)                        = 1
write(2, &#34;552&#34;, 3)                      = 3
write(2, &#34; +&#34;, 2)                       = 2
write(2, &#34;0x21&#34;, 4)                     = 4
write(2, &#34;\n&#34;, 1)                       = 1
</code></pre><p>Just take the raw strings, you can even evaluate them as JavaScript <code>+</code> operator in your browser&rsquo;s
JS console for example to re-assemble them:</p>
<pre tabindex="0"><code>&#34;SIGQUIT: quit&#34; +
&#34;\n&#34; +
&#34;PC=&#34; +
&#34;0x464ce1&#34; +
&#34; m=&#34; +
&#34;0&#34; +
&#34; sigcode=&#34; +
&#34;0&#34; +
&#34;\n&#34; +
&#34;\n&#34; +
&#34;goroutine &#34; +
&#34;0&#34; +
&#34; [&#34; +
&#34;idle&#34; +
&#34;]:\n&#34; +
&#34;runtime.futex&#34; +
&#34;(&#34; +
&#34;)\n&#34; +
&#34;\t&#34; +
&#34;/usr/local/go/src/runtime/sys_linux_amd64.s&#34; +
&#34;:&#34; +
&#34;552&#34; +
&#34; +&#34; +
&#34;0x21&#34; +
&#34;\n&#34;;
</code></pre><p>-&gt;</p>
<pre tabindex="0"><code>SIGQUIT: quit\nPC=0x464ce1 m=0 sigcode=0\n\ngoroutine 0 [idle]:\nruntime.futex()\n\t/usr/local/go/src/runtime/sys_linux_amd64.s:552 +0x21\n
</code></pre><p>And then replacing the <code>\n</code> with newline and <code>\t</code> with tab:</p>
<pre tabindex="0"><code>SIGQUIT: quit
PC=0x464ce1 m=0 sigcode=0

goroutine 0 [idle]:
runtime.futex()
	/usr/local/go/src/runtime/sys_linux_amd64.s:552 +0x21
</code></pre><p>So we recovered important data even from a situation where the data was being sent to the dumpster! 🗑</p>
<p>Have fun with your new superpowers!</p>

    </div>
	<div class="post-footer">
		<hr />

		<img src="/signature.png" alt="signature" style="height: 55px;" />

		<p>Thanks for reading! <span style="font-style: normal;">😍</span></p>
		<p>
			If you like my writing, consider following me on
			<a href="https://twitter.com/joonas_fi">Twitter</a>.
		</p>

		<p>
			Stay updated on my blog posts &amp; projects - sign up for
			<a href="https://buttondown.email/joonas">my newsletter</a>. 🚀
			<br />
			<small>
				No spam, unsubscribe any time.
				<a href="/feed.xml">RSS</a> also available.
			</small>
		</p>
	</div>
  </article>

  <hr />

  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2023  joonas.fi 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/today-i-learned/">Today I Learned</a></li>
         
        <li><a href="/about/">About</a></li>
         
        <li><a href="/contact/">Contact</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>



</html>
